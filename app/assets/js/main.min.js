(function() {
  'use strict';

  angular.module('app', [
    'app.core',
    //'app.widgets',
    //'app.admin',
    'app.dashboard'
  ]);

})();

(function() {
  'use strict';

  angular
    .module('app.core', [
        'ngAnimate',
        'ngSanitize',
        'ngRoute',

        // 3rd paty
        'lumx',
        'angular-electron',
        'ngStorage',
        'timer'
    ]);
})();

(function() {
  'use strict';

  angular.module('app.dashboard', ['app.core']);
})();

(function() {
  'use strict';

  angular.module('blocks.exception', ['blocks.logger']);
})();

(function() {
  'use strict';

  angular.module('blocks.logger', []);
})();

(function() {
  'use strict';

  angular.module('blocks.router', [
    'ui.router',
    'blocks.logger'
  ]);
})();

(function() {
  'use strict';

  var config = {
    clientId: '6777100542.apps.bexio.com',
    clientSecret: 'FfdjCu3Q3Rp8Ujmcch2iFGHJC3o=',
    authorizationUrl: 'https://office.bexio.com/oauth/authorize',
    tokenUrl: 'https://office.bexio.com/oauth/access_token',
    useBasicAuthorizationHeader: false
  };

  var scopes = [
    'article_show',
    'calendar_show',
    'contact_show',
    'lead_show',
    'task_show',
    'monitoring_show',
    'monitoring_edit',
    'project_show'
  ];

  angular
    .module('app.core')
    .factory('authservice', ['electron-oauth2', '$localStorage', authservice ]);


  function authservice(electronOauth2, $localStorage) {
    var service = {
      getAccessToken: getAccessToken
    };

    return service;

    function getAccessToken() {
      var windowParams = {
        width: 800,
        height: 600,
        alwaysOnTop: true,
        autoHideMenuBar: true,
        webPreferences: {
          nodeIntegration: false
        },
        closable: false,
        frame: false,
        center: true
      };
      
      var options = {
        scope: scopes.join(' '),
        state: Math.random().toString(36).substring(7)
      };

      var myApiOauth = electronOauth2(config, windowParams);

      // Get access token promise (electron-oauth2)
      return myApiOauth.getAccessToken(options)
    }
  }
})();

(function() {
  'use strict';

  bexioservice.$inject = ['$http', '$q', '$localStorage'];
  angular
    .module('app.core')
    .factory('bexioservice', bexioservice);

  /* @ngInject */
  function bexioservice($http, $q, $localStorage) {
    var service = {
      getTimesByUser: getTimesByUser,
      getProjects: getProjects,
      getProjectById: getProjectById,
      getContacts: getContacts,
      getContactById: getContactById,
      getServices: getServices,
      getServiceById: getServiceById
    };

    return service;

    // Read user data
    function getTimesByUser(userId) {
      var userData = $localStorage.userData;

      var filter = [
        {
          'field': 'user_id',
          'value': userId
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/timesheet/search?&limit=20&order_by=id_desc`,
        data: filter
      };

      return $http(request);

    }

    function getProjects() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/pr_project?order_by=id`
      };

      return $http(request);
    }

    function getProjectById(id) {
      return  getObjById($localStorage.projects, 'id', id);
    }

    function getContacts() {
      var userData = $localStorage.userData;

      var filter = [
        {
          "field": "contact_type_id",
          "value": 1
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/contact/search`,
        data: filter
      };

      return $http(request);
    }

    function getContactById(id) {
      return  getObjById($localStorage.contacts, 'id', id);
    }

    function getObjById(obj, field, value) {
      var search = {};
      search[field] = value;

      return _.findWhere(obj, search);
    }

    function getServices() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/client_service`
      };

      return $http(request);
    }

    function getServiceById(id) {
      return  getObjById($localStorage.services, 'id', id);
    }
  }
})();

(function() {
  'use strict';

  var core = angular.module('app.core');

  core
      .config(['remoteProvider', function(remoteProvider) {
        remoteProvider.register('electron-oauth2');
      }])
      .run(['$http', '$localStorage', function($http, $localStorage) {
          if ($localStorage.userData) {
              $http.defaults.headers.common.Authorization = `Bearer ${$localStorage.userData.access_token}`;
              $http.defaults.headers.common.Accept = 'application/json';
          }
      }]);


})();

/* global toastr:false, moment:false */
(function() {
  'use strict';

  angular
    .module('app.core')
})();

(function () {
    'use strict';

    getRoutes.$inject = ['$routeProvider'];
    angular
        .module('app.dashboard')
        .config(getRoutes);

    /* @ngInject */
    function getRoutes($routeProvider) {
        $routeProvider
            .when('/', {
                templateUrl: 'dashboard/dashboard.html',
                controller: 'Dashboard',
                controllerAs: 'vm'
            })
            .otherwise({
                redirectTo: '/'
            });
    }

})();
(function() {
  'use strict';

  Dashboard.$inject = ['$q', 'authservice', '$localStorage', 'bexioservice'];
  angular
    .module('app.dashboard')
    .controller('Dashboard', Dashboard);

  /* @ngInject */
  function Dashboard($q, authservice, $localStorage, bexioservice) {
      var vm = this;
      vm.title = 'Track your Time!';
      vm.times = '';
      vm.projects = '';


      ///////////////////////

      var now = new Date();

      if(!$localStorage.userData) {
          authservice.getAccessToken()
              .then(function(data) {
                  // Save access data
                  var d = new Date();
                  d = new Date(d.getTime() + data.expires_in);
                  data.expires = d.toString();

                  $localStorage.userData = data;
                  return getTimes(data.user_id);
              })
              .then(function(result) {
                  vm.times = result.data;
                  
              });
      } else {
          getTimes($localStorage.userData.user_id)
              .then(function(result) {
                  vm.times = result.data;
              });
      }

      bexioservice.getProjects()
          .then(function(result) {
              $localStorage.projects = vm.projects = result.data;
          });
      
      bexioservice.getContacts()
          .then(function(result) {
              $localStorage.contacts = vm.contacts = result.data;
          });

      bexioservice.getServices()
          .then(function(result) {
              $localStorage.services = vm.services = result.data;
          });

      $q.all([bexioservice.getContacts(), bexioservice.getProjects(), bexioservice.getServices()]).then(function() {
          vm.times = $localStorage.times = _.map(vm.times, function(obj, key) {
              obj.contact = bexioservice.getContactById(obj.contact_id);
              obj.project = bexioservice.getProjectById(obj.pr_project_id);
              obj.client_service = bexioservice.getServiceById(obj.slient_service_id);

              return obj;
          });

          console.log()
      });

      function getTimes(userId) {
          return bexioservice.getTimesByUser(userId);
      }
  }
})();

// Include in index.html so that app level exceptions are handled.
// Exclude from testRunner.html which should run exactly what it wants to run
(function() {
  'use strict';

  angular
    .module('blocks.exception')
    .provider('exceptionHandler', exceptionHandlerProvider)
    .config(config);

  /**
   * Must configure the exception handling
   */
  function exceptionHandlerProvider() {
    /* jshint validthis:true */
    this.config = {
      appErrorPrefix: undefined
    };

    this.configure = function(appErrorPrefix) {
      this.config.appErrorPrefix = appErrorPrefix;
    };

    this.$get = function() {
      return { config: this.config };
    };
  }

  config.$inject = ['$provide'];

  /**
   * Configure by setting an optional string value for appErrorPrefix.
   * Accessible via config.appErrorPrefix (via config value).
   * @param  {Object} $provide
   */
  /* @ngInject */
  function config($provide) {
    $provide.decorator('$exceptionHandler', extendExceptionHandler);
  }

  extendExceptionHandler.$inject = ['$delegate', 'exceptionHandler', 'logger'];

  /**
   * Extend the $exceptionHandler service to also display a toast.
   * @param  {Object} $delegate
   * @param  {Object} exceptionHandler
   * @param  {Object} logger
   * @return {Function} the decorated $exceptionHandler service
   */
  function extendExceptionHandler($delegate, exceptionHandler, logger) {
    return function(exception, cause) {
      var appErrorPrefix = exceptionHandler.config.appErrorPrefix || '';
      var errorData = { exception: exception, cause: cause };
      exception.message = appErrorPrefix + exception.message;
      $delegate(exception, cause);
      /**
       * Could add the error to a service's collection,
       * add errors to $rootScope, log errors to remote web server,
       * or log locally. Or throw hard. It is entirely up to you.
       * throw exception;
       *
       * @example
       *     throw { message: 'error message we added' };
       */
      logger.error(exception.message, errorData);
    };
  }
})();

/* jshint -W117, -W030 */
describe('blocks.exception', function() {
  var exceptionHandlerProvider;
  var mocks = {
    errorMessage: 'fake error',
    prefix: '[TEST]: '
  };

  beforeEach(function() {
    bard.appModule('blocks.exception', function(_exceptionHandlerProvider_) {
      exceptionHandlerProvider = _exceptionHandlerProvider_;
    });
    bard.inject('$rootScope');
  });

  bard.verifyNoOutstandingHttpRequests();

  describe('exceptionHandlerProvider', function() {
    it('should have a dummy test', inject(function() {
      expect(true).to.equal(true);
    }));

    it('should have exceptionHandlerProvider defined', inject(function() {
      expect(exceptionHandlerProvider).to.be.defined;
    }));

    it('should have configuration', inject(function() {
      expect(exceptionHandlerProvider.config).to.be.defined;
    }));

    it('should have configuration', inject(function() {
      expect(exceptionHandlerProvider.configure).to.be.defined;
    }));

    describe('with appErrorPrefix', function() {
      beforeEach(function() {
        exceptionHandlerProvider.configure(mocks.prefix);
      });

      it('should have appErrorPrefix defined', inject(function() {
        expect(exceptionHandlerProvider.$get().config.appErrorPrefix).to.be.defined;
      }));

      it('should have appErrorPrefix set properly', inject(function() {
        expect(exceptionHandlerProvider.$get().config.appErrorPrefix)
          .to.equal(mocks.prefix);
      }));

      it('should throw an error when forced', inject(function() {
        expect(functionThatWillThrow).to.throw();
      }));

      it('manual error is handled by decorator', function() {
        var exception;
        exceptionHandlerProvider.configure(mocks.prefix);
        try {
          $rootScope.$apply(functionThatWillThrow);
        }
        catch (ex) {
          exception = ex;
          expect(ex.message).to.equal(mocks.prefix + mocks.errorMessage);
        }
      });
    });
  });

  function functionThatWillThrow() {
    throw new Error(mocks.errorMessage);
  }
});

(function() {
  'use strict';

  exception.$inject = ['$q', 'logger'];
  angular
    .module('blocks.exception')
    .factory('exception', exception);

  /* @ngInject */
  function exception($q, logger) {
    var service = {
      catcher: catcher
    };
    return service;

    function catcher(message) {
      return function(e) {
        var thrownDescription;
        var newMessage;
        if (e.data && e.data.description) {
          thrownDescription = '\n' + e.data.description;
          newMessage = message + thrownDescription;
        }
        e.data.description = newMessage;
        logger.error(newMessage);
        return $q.reject(e);
      };
    }
  }
})();

(function() {
  'use strict';

  angular
    .module('blocks.logger')
    .factory('logger', logger);

  logger.$inject = ['$log', 'toastr'];

  /* @ngInject */
  function logger($log, toastr) {
    var service = {
      showToasts: true,

      error: error,
      info: info,
      success: success,
      warning: warning,

      // straight to console; bypass toastr
      log: $log.log
    };

    return service;
    /////////////////////

    function error(message, data, title) {
      toastr.error(message, title);
      $log.error('Error: ' + message, data);
    }

    function info(message, data, title) {
      toastr.info(message, title);
      $log.info('Info: ' + message, data);
    }

    function success(message, data, title) {
      toastr.success(message, title);
      $log.info('Success: ' + message, data);
    }

    function warning(message, data, title) {
      toastr.warning(message, title);
      $log.warn('Warning: ' + message, data);
    }
  }
} ());

/* Help configure the state-base ui.router */
(function() {
  'use strict';

  angular
    .module('blocks.router')
    .provider('routerHelper', routerHelperProvider);

  routerHelperProvider.$inject = ['$locationProvider', '$stateProvider', '$urlRouterProvider'];
  /* @ngInject */
  function routerHelperProvider($locationProvider, $stateProvider, $urlRouterProvider) {
    /* jshint validthis:true */
    var config = {
      docTitle: undefined,
      resolveAlways: {}
    };

    if (!(window.history && window.history.pushState)) {
      window.location.hash = '/';
    }

    $locationProvider.html5Mode(true);

    this.configure = function(cfg) {
      angular.extend(config, cfg);
    };

    this.$get = RouterHelper;
    RouterHelper.$inject = ['$location', '$rootScope', '$state', 'logger'];
    /* @ngInject */
    function RouterHelper($location, $rootScope, $state, logger) {
      var handlingStateChangeError = false;
      var hasOtherwise = false;
      var stateCounts = {
        errors: 0,
        changes: 0
      };

      var service = {
        configureStates: configureStates,
        getStates: getStates,
        stateCounts: stateCounts
      };

      init();

      return service;

      ///////////////

      function configureStates(states, otherwisePath) {
        states.forEach(function(state) {
          state.config.resolve =
            angular.extend(state.config.resolve || {}, config.resolveAlways);
          $stateProvider.state(state.state, state.config);
        });
        if (otherwisePath && !hasOtherwise) {
          hasOtherwise = true;
          $urlRouterProvider.otherwise(otherwisePath);
        }
      }

      function handleRoutingErrors() {
        // Route cancellation:
        // On routing error, go to the dashboard.
        // Provide an exit clause if it tries to do it twice.
        $rootScope.$on('$stateChangeError',
          function(event, toState, toParams, fromState, fromParams, error) {
            if (handlingStateChangeError) {
              return;
            }
            stateCounts.errors++;
            handlingStateChangeError = true;
            var destination = (toState &&
              (toState.title || toState.name || toState.loadedTemplateUrl)) ||
              'unknown target';
            var msg = 'Error routing to ' + destination + '. ' +
              (error.data || '') + '. <br/>' + (error.statusText || '') +
              ': ' + (error.status || '');
            logger.warning(msg, [toState]);
            $location.path('/');
          }
        );
      }

      function init() {
        handleRoutingErrors();
        updateDocTitle();
      }

      function getStates() { return $state.get(); }

      function updateDocTitle() {
        $rootScope.$on('$stateChangeSuccess',
          function(event, toState, toParams, fromState, fromParams) {
            stateCounts.changes++;
            handlingStateChangeError = false;
            var title = config.docTitle + ' ' + (toState.title || '');
            $rootScope.title = title; // data bind to <title>
          }
        );
      }
    }
  }
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5tb2R1bGUuanMiLCJjb3JlL2NvcmUubW9kdWxlLmpzIiwiZGFzaGJvYXJkL2Rhc2hib2FyZC5tb2R1bGUuanMiLCJibG9ja3MvZXhjZXB0aW9uL2V4Y2VwdGlvbi5tb2R1bGUuanMiLCJibG9ja3MvbG9nZ2VyL2xvZ2dlci5tb2R1bGUuanMiLCJibG9ja3Mvcm91dGVyL3JvdXRlci5tb2R1bGUuanMiLCJjb3JlL2F1dGhzZXJ2aWNlLmpzIiwiY29yZS9iZXhpb3NlcnZpY2UuanMiLCJjb3JlL2NvbmZpZy5qcyIsImNvcmUvY29uc3RhbnRzLmpzIiwiZGFzaGJvYXJkL2NvbmZpZy5yb3V0ZS5qcyIsImRhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyIsImJsb2Nrcy9leGNlcHRpb24vZXhjZXB0aW9uLWhhbmRsZXIucHJvdmlkZXIuanMiLCJibG9ja3MvZXhjZXB0aW9uL2V4Y2VwdGlvbi1oYW5kbGVyLnByb3ZpZGVyLnNwZWMuanMiLCJibG9ja3MvZXhjZXB0aW9uL2V4Y2VwdGlvbi5qcyIsImJsb2Nrcy9sb2dnZXIvbG9nZ2VyLmpzIiwiYmxvY2tzL3JvdXRlci9yb3V0ZXItaGVscGVyLnByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLENBQUEsV0FBQTtFQUNBOztFQUVBLFFBQUEsT0FBQSxPQUFBO0lBQ0E7OztJQUdBOzs7OztBQ1BBLENBQUEsV0FBQTtFQUNBOztFQUVBO0tBQ0EsT0FBQSxZQUFBO1FBQ0E7UUFDQTtRQUNBOzs7UUFHQTtRQUNBO1FBQ0E7UUFDQTs7OztBQ2JBLENBQUEsV0FBQTtFQUNBOztFQUVBLFFBQUEsT0FBQSxpQkFBQSxDQUFBOzs7QUNIQSxDQUFBLFdBQUE7RUFDQTs7RUFFQSxRQUFBLE9BQUEsb0JBQUEsQ0FBQTs7O0FDSEEsQ0FBQSxXQUFBO0VBQ0E7O0VBRUEsUUFBQSxPQUFBLGlCQUFBOzs7QUNIQSxDQUFBLFdBQUE7RUFDQTs7RUFFQSxRQUFBLE9BQUEsaUJBQUE7SUFDQTtJQUNBOzs7O0FDTEEsQ0FBQSxXQUFBO0VBQ0E7O0VBRUEsSUFBQSxTQUFBO0lBQ0EsVUFBQTtJQUNBLGNBQUE7SUFDQSxrQkFBQTtJQUNBLFVBQUE7SUFDQSw2QkFBQTs7O0VBR0EsSUFBQSxTQUFBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTs7O0VBR0E7S0FDQSxPQUFBO0tBQ0EsUUFBQSxlQUFBLENBQUEsbUJBQUEsaUJBQUE7OztFQUdBLFNBQUEsWUFBQSxnQkFBQSxlQUFBO0lBQ0EsSUFBQSxVQUFBO01BQ0EsZ0JBQUE7OztJQUdBLE9BQUE7O0lBRUEsU0FBQSxpQkFBQTtNQUNBLElBQUEsZUFBQTtRQUNBLE9BQUE7UUFDQSxRQUFBO1FBQ0EsYUFBQTtRQUNBLGlCQUFBO1FBQ0EsZ0JBQUE7VUFDQSxpQkFBQTs7UUFFQSxVQUFBO1FBQ0EsT0FBQTtRQUNBLFFBQUE7OztNQUdBLElBQUEsVUFBQTtRQUNBLE9BQUEsT0FBQSxLQUFBO1FBQ0EsT0FBQSxLQUFBLFNBQUEsU0FBQSxJQUFBLFVBQUE7OztNQUdBLElBQUEsYUFBQSxlQUFBLFFBQUE7OztNQUdBLE9BQUEsV0FBQSxlQUFBOzs7OztBQ3hEQSxDQUFBLFdBQUE7RUFDQTs7O0VBRUE7S0FDQSxPQUFBO0tBQ0EsUUFBQSxnQkFBQTs7O0VBR0EsU0FBQSxhQUFBLE9BQUEsSUFBQSxlQUFBO0lBQ0EsSUFBQSxVQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7OztJQUdBLE9BQUE7OztJQUdBLFNBQUEsZUFBQSxRQUFBO01BQ0EsSUFBQSxXQUFBLGNBQUE7O01BRUEsSUFBQSxTQUFBO1FBQ0E7VUFDQSxTQUFBO1VBQ0EsU0FBQTs7OztNQUlBLElBQUEsVUFBQTtRQUNBLFFBQUE7UUFDQSxLQUFBO1FBQ0EsTUFBQTs7O01BR0EsT0FBQSxNQUFBOzs7O0lBSUEsU0FBQSxjQUFBO01BQ0EsSUFBQSxXQUFBLGNBQUE7O01BRUEsSUFBQSxVQUFBO1FBQ0EsUUFBQTtRQUNBLEtBQUE7OztNQUdBLE9BQUEsTUFBQTs7O0lBR0EsU0FBQSxlQUFBLElBQUE7TUFDQSxRQUFBLFdBQUEsY0FBQSxVQUFBLE1BQUE7OztJQUdBLFNBQUEsY0FBQTtNQUNBLElBQUEsV0FBQSxjQUFBOztNQUVBLElBQUEsU0FBQTtRQUNBO1VBQ0EsU0FBQTtVQUNBLFNBQUE7Ozs7TUFJQSxJQUFBLFVBQUE7UUFDQSxRQUFBO1FBQ0EsS0FBQTtRQUNBLE1BQUE7OztNQUdBLE9BQUEsTUFBQTs7O0lBR0EsU0FBQSxlQUFBLElBQUE7TUFDQSxRQUFBLFdBQUEsY0FBQSxVQUFBLE1BQUE7OztJQUdBLFNBQUEsV0FBQSxLQUFBLE9BQUEsT0FBQTtNQUNBLElBQUEsU0FBQTtNQUNBLE9BQUEsU0FBQTs7TUFFQSxPQUFBLEVBQUEsVUFBQSxLQUFBOzs7SUFHQSxTQUFBLGNBQUE7TUFDQSxJQUFBLFdBQUEsY0FBQTs7TUFFQSxJQUFBLFVBQUE7UUFDQSxRQUFBO1FBQ0EsS0FBQTs7O01BR0EsT0FBQSxNQUFBOzs7SUFHQSxTQUFBLGVBQUEsSUFBQTtNQUNBLFFBQUEsV0FBQSxjQUFBLFVBQUEsTUFBQTs7Ozs7QUNuR0EsQ0FBQSxXQUFBO0VBQ0E7O0VBRUEsSUFBQSxPQUFBLFFBQUEsT0FBQTs7RUFFQTtPQUNBLE9BQUEsQ0FBQSxrQkFBQSxTQUFBLGdCQUFBO1FBQ0EsZUFBQSxTQUFBOztPQUVBLElBQUEsQ0FBQSxTQUFBLGlCQUFBLFNBQUEsT0FBQSxlQUFBO1VBQ0EsSUFBQSxjQUFBLFVBQUE7Y0FDQSxNQUFBLFNBQUEsUUFBQSxPQUFBLGdCQUFBO2NBQ0EsTUFBQSxTQUFBLFFBQUEsT0FBQSxTQUFBOzs7Ozs7OztBQ1hBLENBQUEsV0FBQTtFQUNBOztFQUVBO0tBQ0EsT0FBQTs7O0FDTEEsQ0FBQSxZQUFBO0lBQ0E7OztJQUVBO1NBQ0EsT0FBQTtTQUNBLE9BQUE7OztJQUdBLFNBQUEsVUFBQSxnQkFBQTtRQUNBO2FBQ0EsS0FBQSxLQUFBO2dCQUNBLGFBQUE7Z0JBQ0Es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QSxRQUFBLFVBQUE7O0VBRUEsT0FBQSxVQUFBLENBQUEsUUFBQTs7O0VBR0EsU0FBQSxPQUFBLE1BQUEsUUFBQTtJQUNBLElBQUEsVUFBQTtNQUNBLFlBQUE7O01BRUEsT0FBQTtNQUNBLE1BQUE7TUFDQSxTQUFBO01BQ0EsU0FBQTs7O01BR0EsS0FBQSxLQUFBOzs7SUFHQSxPQUFBOzs7SUFHQSxTQUFBLE1BQUEsU0FBQSxNQUFBLE9BQUE7TUFDQSxPQUFBLE1BQUEsU0FBQTtNQUNBLEtBQUEsTUFBQSxZQUFBLFNBQUE7OztJQUdBLFNBQUEsS0FBQSxTQUFBLE1BQUEsT0FBQTtNQUNBLE9BQUEsS0FBQSxTQUFBO01BQ0EsS0FBQSxLQUFBLFdBQUEsU0FBQTs7O0lBR0EsU0FBQSxRQUFBLFNBQUEsTUFBQSxPQUFBO01BQ0EsT0FBQSxRQUFBLFNBQUE7TUFDQSxLQUFBLEtBQUEsY0FBQSxTQUFBOzs7SUFHQSxTQUFBLFFBQUEsU0FBQSxNQUFBLE9BQUE7TUFDQSxPQUFBLFFBQUEsU0FBQTtNQUNBLEtBQUEsS0FBQSxjQUFBLFNBQUE7Ozs7OztBQzFDQSxDQUFBLFdBQUE7RUFDQTs7RUFFQTtLQUNBLE9BQUE7S0FDQSxTQUFBLGdCQUFBOztFQUVBLHFCQUFBLFVBQUEsQ0FBQSxxQkFBQSxrQkFBQTs7RUFFQSxTQUFBLHFCQUFBLG1CQUFBLGdCQUFBLG9CQUFBOztJQUVBLElBQUEsU0FBQTtNQUNBLFVBQUE7TUFDQSxlQUFBOzs7SUFHQSxJQUFBLEVBQUEsT0FBQSxXQUFBLE9BQUEsUUFBQSxZQUFBO01BQ0EsT0FBQSxTQUFBLE9BQUE7OztJQUdBLGtCQUFBLFVBQUE7O0lBRUEsS0FBQSxZQUFBLFNBQUEsS0FBQTtNQUNBLFFBQUEsT0FBQSxRQUFBOzs7SUFHQSxLQUFBLE9BQUE7SUFDQSxhQUFBLFVBQUEsQ0FBQSxhQUFBLGNBQUEsVUFBQTs7SUFFQSxTQUFBLGFBQUEsV0FBQSxZQUFBLFFBQUEsUUFBQTtNQUNBLElBQUEsMkJBQUE7TUFDQSxJQUFBLGVBQUE7TUFDQSxJQUFBLGNBQUE7UUFDQSxRQUFBO1FBQ0EsU0FBQTs7O01BR0EsSUFBQSxVQUFBO1FBQ0EsaUJBQUE7UUFDQSxXQUFBO1FBQ0EsYUFBQTs7O01BR0E7O01BRUEsT0FBQTs7OztNQUlBLFNBQUEsZ0JBQUEsUUFBQSxlQUFBO1FBQ0EsT0FBQSxRQUFBLFNBQUEsT0FBQTtVQUNBLE1BQUEsT0FBQTtZQUNBLFFBQUEsT0FBQSxNQUFBLE9BQUEsV0FBQSxJQUFBLE9BQUE7VUFDQSxlQUFBLE1BQUEsTUFBQSxPQUFBLE1BQUE7O1FBRUEsSUFBQSxpQkFBQSxDQUFBLGNBQUE7VUFDQSxlQUFBO1VBQ0EsbUJBQUEsVUFBQTs7OztNQUlBLFNBQUEsc0JBQUE7Ozs7UUFJQSxXQUFBLElBQUE7VUFDQSxTQUFBLE9BQUEsU0FBQSxVQUFBLFdBQUEsWUFBQSxPQUFBO1lBQ0EsSUFBQSwwQkFBQTtjQUNBOztZQUVBLFlBQUE7WUFDQSwyQkFBQTtZQUNBLElBQUEsY0FBQSxDQUFBO2VBQ0EsUUFBQSxTQUFBLFFBQUEsUUFBQSxRQUFBO2NBQ0E7WUFDQSxJQUFBLE1BQUEsc0JBQUEsY0FBQTtlQUNBLE1BQUEsUUFBQSxNQUFBLGFBQUEsTUFBQSxjQUFBO2NBQ0EsUUFBQSxNQUFBLFVBQUE7WUFDQSxPQUFBLFFBQUEsS0FBQSxDQUFBO1lBQ0EsVUFBQSxLQUFBOzs7OztNQUtBLFNBQUEsT0FBQTtRQUNBO1FBQ0E7OztNQUdBLFNBQUEsWUFBQSxFQUFBLE9BQUEsT0FBQTs7TUFFQSxTQUFBLGlCQUFBO1FBQ0EsV0FBQSxJQUFBO1VBQ0EsU0FBQSxPQUFBLFNBQUEsVUFBQSxXQUFBLFlBQUE7WUFDQSxZQUFBO1lBQ0EsMkJBQUE7WUFDQSxJQUFBLFFBQUEsT0FBQSxXQUFBLE9BQUEsUUFBQSxTQUFBO1lBQ0EsV0FBQSxRQUFBOzs7Ozs7O0FBT0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyLm1vZHVsZSgnYXBwJywgW1xuICAgICdhcHAuY29yZScsXG4gICAgLy8nYXBwLndpZGdldHMnLFxuICAgIC8vJ2FwcC5hZG1pbicsXG4gICAgJ2FwcC5kYXNoYm9hcmQnXG4gIF0pO1xuXG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2FwcC5jb3JlJywgW1xuICAgICAgICAnbmdBbmltYXRlJyxcbiAgICAgICAgJ25nU2FuaXRpemUnLFxuICAgICAgICAnbmdSb3V0ZScsXG5cbiAgICAgICAgLy8gM3JkIHBhdHlcbiAgICAgICAgJ2x1bXgnLFxuICAgICAgICAnYW5ndWxhci1lbGVjdHJvbicsXG4gICAgICAgICduZ1N0b3JhZ2UnLFxuICAgICAgICAndGltZXInXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhci5tb2R1bGUoJ2FwcC5kYXNoYm9hcmQnLCBbJ2FwcC5jb3JlJ10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXIubW9kdWxlKCdibG9ja3MuZXhjZXB0aW9uJywgWydibG9ja3MubG9nZ2VyJ10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXIubW9kdWxlKCdibG9ja3MubG9nZ2VyJywgW10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXIubW9kdWxlKCdibG9ja3Mucm91dGVyJywgW1xuICAgICd1aS5yb3V0ZXInLFxuICAgICdibG9ja3MubG9nZ2VyJ1xuICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICB2YXIgY29uZmlnID0ge1xuICAgIGNsaWVudElkOiAnNjc3NzEwMDU0Mi5hcHBzLmJleGlvLmNvbScsXG4gICAgY2xpZW50U2VjcmV0OiAnRmZkakN1M1EzUnA4VWptY2NoMmlGR0hKQzNvPScsXG4gICAgYXV0aG9yaXphdGlvblVybDogJ2h0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9vYXV0aC9hdXRob3JpemUnLFxuICAgIHRva2VuVXJsOiAnaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL29hdXRoL2FjY2Vzc190b2tlbicsXG4gICAgdXNlQmFzaWNBdXRob3JpemF0aW9uSGVhZGVyOiBmYWxzZVxuICB9O1xuXG4gIHZhciBzY29wZXMgPSBbXG4gICAgJ2FydGljbGVfc2hvdycsXG4gICAgJ2NhbGVuZGFyX3Nob3cnLFxuICAgICdjb250YWN0X3Nob3cnLFxuICAgICdsZWFkX3Nob3cnLFxuICAgICd0YXNrX3Nob3cnLFxuICAgICdtb25pdG9yaW5nX3Nob3cnLFxuICAgICdtb25pdG9yaW5nX2VkaXQnLFxuICAgICdwcm9qZWN0X3Nob3cnXG4gIF07XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2FwcC5jb3JlJylcbiAgICAuZmFjdG9yeSgnYXV0aHNlcnZpY2UnLCBbJ2VsZWN0cm9uLW9hdXRoMicsICckbG9jYWxTdG9yYWdlJywgYXV0aHNlcnZpY2UgXSk7XG5cblxuICBmdW5jdGlvbiBhdXRoc2VydmljZShlbGVjdHJvbk9hdXRoMiwgJGxvY2FsU3RvcmFnZSkge1xuICAgIHZhciBzZXJ2aWNlID0ge1xuICAgICAgZ2V0QWNjZXNzVG9rZW46IGdldEFjY2Vzc1Rva2VuXG4gICAgfTtcblxuICAgIHJldHVybiBzZXJ2aWNlO1xuXG4gICAgZnVuY3Rpb24gZ2V0QWNjZXNzVG9rZW4oKSB7XG4gICAgICB2YXIgd2luZG93UGFyYW1zID0ge1xuICAgICAgICB3aWR0aDogODAwLFxuICAgICAgICBoZWlnaHQ6IDYwMCxcbiAgICAgICAgYWx3YXlzT25Ub3A6IHRydWUsXG4gICAgICAgIGF1dG9IaWRlTWVudUJhcjogdHJ1ZSxcbiAgICAgICAgd2ViUHJlZmVyZW5jZXM6IHtcbiAgICAgICAgICBub2RlSW50ZWdyYXRpb246IGZhbHNlXG4gICAgICAgIH0sXG4gICAgICAgIGNsb3NhYmxlOiBmYWxzZSxcbiAgICAgICAgZnJhbWU6IGZhbHNlLFxuICAgICAgICBjZW50ZXI6IHRydWVcbiAgICAgIH07XG4gICAgICBcbiAgICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgICBzY29wZTogc2NvcGVzLmpvaW4oJyAnKSxcbiAgICAgICAgc3RhdGU6IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KVxuICAgICAgfTtcblxuICAgICAgdmFyIG15QXBpT2F1dGggPSBlbGVjdHJvbk9hdXRoMihjb25maWcsIHdpbmRvd1BhcmFtcyk7XG5cbiAgICAgIC8vIEdldCBhY2Nlc3MgdG9rZW4gcHJvbWlzZSAoZWxlY3Ryb24tb2F1dGgyKVxuICAgICAgcmV0dXJuIG15QXBpT2F1dGguZ2V0QWNjZXNzVG9rZW4ob3B0aW9ucylcbiAgICB9XG4gIH1cbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmNvcmUnKVxuICAgIC5mYWN0b3J5KCdiZXhpb3NlcnZpY2UnLCBiZXhpb3NlcnZpY2UpO1xuXG4gIC8qIEBuZ0luamVjdCAqL1xuICBmdW5jdGlvbiBiZXhpb3NlcnZpY2UoJGh0dHAsICRxLCAkbG9jYWxTdG9yYWdlKSB7XG4gICAgdmFyIHNlcnZpY2UgPSB7XG4gICAgICBnZXRUaW1lc0J5VXNlcjogZ2V0VGltZXNCeVVzZXIsXG4gICAgICBnZXRQcm9qZWN0czogZ2V0UHJvamVjdHMsXG4gICAgICBnZXRQcm9qZWN0QnlJZDogZ2V0UHJvamVjdEJ5SWQsXG4gICAgICBnZXRDb250YWN0czogZ2V0Q29udGFjdHMsXG4gICAgICBnZXRDb250YWN0QnlJZDogZ2V0Q29udGFjdEJ5SWQsXG4gICAgICBnZXRTZXJ2aWNlczogZ2V0U2VydmljZXMsXG4gICAgICBnZXRTZXJ2aWNlQnlJZDogZ2V0U2VydmljZUJ5SWRcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZpY2U7XG5cbiAgICAvLyBSZWFkIHVzZXIgZGF0YVxuICAgIGZ1bmN0aW9uIGdldFRpbWVzQnlVc2VyKHVzZXJJZCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIGZpbHRlciA9IFtcbiAgICAgICAge1xuICAgICAgICAgICdmaWVsZCc6ICd1c2VyX2lkJyxcbiAgICAgICAgICAndmFsdWUnOiB1c2VySWRcbiAgICAgICAgfVxuICAgICAgXTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICB1cmw6IGBodHRwczovL29mZmljZS5iZXhpby5jb20vYXBpMi5waHAvJHt1c2VyRGF0YS5vcmd9L3RpbWVzaGVldC9zZWFyY2g/JmxpbWl0PTIwJm9yZGVyX2J5PWlkX2Rlc2NgLFxuICAgICAgICBkYXRhOiBmaWx0ZXJcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiAkaHR0cChyZXF1ZXN0KTtcblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFByb2plY3RzKCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHVybDogYGh0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9hcGkyLnBocC8ke3VzZXJEYXRhLm9yZ30vcHJfcHJvamVjdD9vcmRlcl9ieT1pZGBcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiAkaHR0cChyZXF1ZXN0KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRQcm9qZWN0QnlJZChpZCkge1xuICAgICAgcmV0dXJuICBnZXRPYmpCeUlkKCRsb2NhbFN0b3JhZ2UucHJvamVjdHMsICdpZCcsIGlkKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRDb250YWN0cygpIHtcbiAgICAgIHZhciB1c2VyRGF0YSA9ICRsb2NhbFN0b3JhZ2UudXNlckRhdGE7XG5cbiAgICAgIHZhciBmaWx0ZXIgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBcImZpZWxkXCI6IFwiY29udGFjdF90eXBlX2lkXCIsXG4gICAgICAgICAgXCJ2YWx1ZVwiOiAxXG4gICAgICAgIH1cbiAgICAgIF07XG5cbiAgICAgIHZhciByZXF1ZXN0ID0ge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL2FwaTIucGhwLyR7dXNlckRhdGEub3JnfS9jb250YWN0L3NlYXJjaGAsXG4gICAgICAgIGRhdGE6IGZpbHRlclxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldENvbnRhY3RCeUlkKGlkKSB7XG4gICAgICByZXR1cm4gIGdldE9iakJ5SWQoJGxvY2FsU3RvcmFnZS5jb250YWN0cywgJ2lkJywgaWQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldE9iakJ5SWQob2JqLCBmaWVsZCwgdmFsdWUpIHtcbiAgICAgIHZhciBzZWFyY2ggPSB7fTtcbiAgICAgIHNlYXJjaFtmaWVsZF0gPSB2YWx1ZTtcblxuICAgICAgcmV0dXJuIF8uZmluZFdoZXJlKG9iaiwgc2VhcmNoKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlcygpIHtcbiAgICAgIHZhciB1c2VyRGF0YSA9ICRsb2NhbFN0b3JhZ2UudXNlckRhdGE7XG5cbiAgICAgIHZhciByZXF1ZXN0ID0ge1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICB1cmw6IGBodHRwczovL29mZmljZS5iZXhpby5jb20vYXBpMi5waHAvJHt1c2VyRGF0YS5vcmd9L2NsaWVudF9zZXJ2aWNlYFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFNlcnZpY2VCeUlkKGlkKSB7XG4gICAgICByZXR1cm4gIGdldE9iakJ5SWQoJGxvY2FsU3RvcmFnZS5zZXJ2aWNlcywgJ2lkJywgaWQpO1xuICAgIH1cbiAgfVxufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciBjb3JlID0gYW5ndWxhci5tb2R1bGUoJ2FwcC5jb3JlJyk7XG5cbiAgY29yZVxuICAgICAgLmNvbmZpZyhbJ3JlbW90ZVByb3ZpZGVyJywgZnVuY3Rpb24ocmVtb3RlUHJvdmlkZXIpIHtcbiAgICAgICAgcmVtb3RlUHJvdmlkZXIucmVnaXN0ZXIoJ2VsZWN0cm9uLW9hdXRoMicpO1xuICAgICAgfV0pXG4gICAgICAucnVuKFsnJGh0dHAnLCAnJGxvY2FsU3RvcmFnZScsIGZ1bmN0aW9uKCRodHRwLCAkbG9jYWxTdG9yYWdlKSB7XG4gICAgICAgICAgaWYgKCRsb2NhbFN0b3JhZ2UudXNlckRhdGEpIHtcbiAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMuaGVhZGVycy5jb21tb24uQXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHskbG9jYWxTdG9yYWdlLnVzZXJEYXRhLmFjY2Vzc190b2tlbn1gO1xuICAgICAgICAgICAgICAkaHR0cC5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbi5BY2NlcHQgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgICAgICAgfVxuICAgICAgfV0pO1xuXG5cbn0pKCk7XG4iLCIvKiBnbG9iYWwgdG9hc3RyOmZhbHNlLCBtb21lbnQ6ZmFsc2UgKi9cbihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdhcHAuY29yZScpXG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ2FwcC5kYXNoYm9hcmQnKVxuICAgICAgICAuY29uZmlnKGdldFJvdXRlcyk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBnZXRSb3V0ZXMoJHJvdXRlUHJvdmlkZXIpIHtcbiAgICAgICAgJHJvdXRlUHJvdmlkZXJcbiAgICAgICAgICAgIC53aGVuKCcvJywge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnZGFzaGJvYXJkL2Rhc2hib2FyZC5odG1sJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnRGFzaGJvYXJkJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyQXM6ICd2bSdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub3RoZXJ3aXNlKHtcbiAgICAgICAgICAgICAgICByZWRpcmVjdFRvOiAnLydcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmRhc2hib2FyZCcpXG4gICAgLmNvbnRyb2xsZXIoJ0Rhc2hib2FyZCcsIERhc2hib2FyZCk7XG5cbiAgLyogQG5nSW5qZWN0ICovXG4gIGZ1bmN0aW9uIERhc2hib2FyZCgkcSwgYXV0aHNlcnZpY2UsICRsb2NhbFN0b3JhZ2UsIGJleGlvc2VydmljZSkge1xuICAgICAgdmFyIHZtID0gdGhpcztcbiAgICAgIHZtLnRpdGxlID0gJ1RyYWNrIHlvdXIgVGltZSEnO1xuICAgICAgdm0udGltZXMgPSAnJztcbiAgICAgIHZtLnByb2plY3RzID0gJyc7XG5cblxuICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGlmKCEkbG9jYWxTdG9yYWdlLnVzZXJEYXRhKSB7XG4gICAgICAgICAgYXV0aHNlcnZpY2UuZ2V0QWNjZXNzVG9rZW4oKVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAvLyBTYXZlIGFjY2VzcyBkYXRhXG4gICAgICAgICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICBkID0gbmV3IERhdGUoZC5nZXRUaW1lKCkgKyBkYXRhLmV4cGlyZXNfaW4pO1xuICAgICAgICAgICAgICAgICAgZGF0YS5leHBpcmVzID0gZC50b1N0cmluZygpO1xuXG4gICAgICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnVzZXJEYXRhID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRUaW1lcyhkYXRhLnVzZXJfaWQpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgIHZtLnRpbWVzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdldFRpbWVzKCRsb2NhbFN0b3JhZ2UudXNlckRhdGEudXNlcl9pZClcbiAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICB2bS50aW1lcyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKClcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgJGxvY2FsU3RvcmFnZS5wcm9qZWN0cyA9IHZtLnByb2plY3RzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgfSk7XG4gICAgICBcbiAgICAgIGJleGlvc2VydmljZS5nZXRDb250YWN0cygpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICRsb2NhbFN0b3JhZ2UuY29udGFjdHMgPSB2bS5jb250YWN0cyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgIH0pO1xuXG4gICAgICBiZXhpb3NlcnZpY2UuZ2V0U2VydmljZXMoKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnNlcnZpY2VzID0gdm0uc2VydmljZXMgPSByZXN1bHQuZGF0YTtcbiAgICAgICAgICB9KTtcblxuICAgICAgJHEuYWxsKFtiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdHMoKSwgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKCksIGJleGlvc2VydmljZS5nZXRTZXJ2aWNlcygpXSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICB2bS50aW1lcyA9ICRsb2NhbFN0b3JhZ2UudGltZXMgPSBfLm1hcCh2bS50aW1lcywgZnVuY3Rpb24ob2JqLCBrZXkpIHtcbiAgICAgICAgICAgICAgb2JqLmNvbnRhY3QgPSBiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdEJ5SWQob2JqLmNvbnRhY3RfaWQpO1xuICAgICAgICAgICAgICBvYmoucHJvamVjdCA9IGJleGlvc2VydmljZS5nZXRQcm9qZWN0QnlJZChvYmoucHJfcHJvamVjdF9pZCk7XG4gICAgICAgICAgICAgIG9iai5jbGllbnRfc2VydmljZSA9IGJleGlvc2VydmljZS5nZXRTZXJ2aWNlQnlJZChvYmouc2xpZW50X3NlcnZpY2VfaWQpO1xuXG4gICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZygpXG4gICAgICB9KTtcblxuICAgICAgZnVuY3Rpb24gZ2V0VGltZXModXNlcklkKSB7XG4gICAgICAgICAgcmV0dXJuIGJleGlvc2VydmljZS5nZXRUaW1lc0J5VXNlcih1c2VySWQpO1xuICAgICAgfVxuICB9XG59KSgpO1xuIiwiLy8gSW5jbHVkZSBpbiBpbmRleC5odG1sIHNvIHRoYXQgYXBwIGxldmVsIGV4Y2VwdGlvbnMgYXJlIGhhbmRsZWQuXG4vLyBFeGNsdWRlIGZyb20gdGVzdFJ1bm5lci5odG1sIHdoaWNoIHNob3VsZCBydW4gZXhhY3RseSB3aGF0IGl0IHdhbnRzIHRvIHJ1blxuKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2Jsb2Nrcy5leGNlcHRpb24nKVxuICAgIC5wcm92aWRlcignZXhjZXB0aW9uSGFuZGxlcicsIGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcilcbiAgICAuY29uZmlnKGNvbmZpZyk7XG5cbiAgLyoqXG4gICAqIE11c3QgY29uZmlndXJlIHRoZSBleGNlcHRpb24gaGFuZGxpbmdcbiAgICovXG4gIGZ1bmN0aW9uIGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHtcbiAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIGFwcEVycm9yUHJlZml4OiB1bmRlZmluZWRcbiAgICB9O1xuXG4gICAgdGhpcy5jb25maWd1cmUgPSBmdW5jdGlvbihhcHBFcnJvclByZWZpeCkge1xuICAgICAgdGhpcy5jb25maWcuYXBwRXJyb3JQcmVmaXggPSBhcHBFcnJvclByZWZpeDtcbiAgICB9O1xuXG4gICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4geyBjb25maWc6IHRoaXMuY29uZmlnIH07XG4gICAgfTtcbiAgfVxuXG4gIGNvbmZpZy4kaW5qZWN0ID0gWyckcHJvdmlkZSddO1xuXG4gIC8qKlxuICAgKiBDb25maWd1cmUgYnkgc2V0dGluZyBhbiBvcHRpb25hbCBzdHJpbmcgdmFsdWUgZm9yIGFwcEVycm9yUHJlZml4LlxuICAgKiBBY2Nlc3NpYmxlIHZpYSBjb25maWcuYXBwRXJyb3JQcmVmaXggKHZpYSBjb25maWcgdmFsdWUpLlxuICAgKiBAcGFyYW0gIHtPYmplY3R9ICRwcm92aWRlXG4gICAqL1xuICAvKiBAbmdJbmplY3QgKi9cbiAgZnVuY3Rpb24gY29uZmlnKCRwcm92aWRlKSB7XG4gICAgJHByb3ZpZGUuZGVjb3JhdG9yKCckZXhjZXB0aW9uSGFuZGxlcicsIGV4dGVuZEV4Y2VwdGlvbkhhbmRsZXIpO1xuICB9XG5cbiAgZXh0ZW5kRXhjZXB0aW9uSGFuZGxlci4kaW5qZWN0ID0gWyckZGVsZWdhdGUnLCAnZXhjZXB0aW9uSGFuZGxlcicsICdsb2dnZXInXTtcblxuICAvKipcbiAgICogRXh0ZW5kIHRoZSAkZXhjZXB0aW9uSGFuZGxlciBzZXJ2aWNlIHRvIGFsc28gZGlzcGxheSBhIHRvYXN0LlxuICAgKiBAcGFyYW0gIHtPYmplY3R9ICRkZWxlZ2F0ZVxuICAgKiBAcGFyYW0gIHtPYmplY3R9IGV4Y2VwdGlvbkhhbmRsZXJcbiAgICogQHBhcmFtICB7T2JqZWN0fSBsb2dnZXJcbiAgICogQHJldHVybiB7RnVuY3Rpb259IHRoZSBkZWNvcmF0ZWQgJGV4Y2VwdGlvbkhhbmRsZXIgc2VydmljZVxuICAgKi9cbiAgZnVuY3Rpb24gZXh0ZW5kRXhjZXB0aW9uSGFuZGxlcigkZGVsZWdhdGUsIGV4Y2VwdGlvbkhhbmRsZXIsIGxvZ2dlcikge1xuICAgIHJldHVybiBmdW5jdGlvbihleGNlcHRpb24sIGNhdXNlKSB7XG4gICAgICB2YXIgYXBwRXJyb3JQcmVmaXggPSBleGNlcHRpb25IYW5kbGVyLmNvbmZpZy5hcHBFcnJvclByZWZpeCB8fCAnJztcbiAgICAgIHZhciBlcnJvckRhdGEgPSB7IGV4Y2VwdGlvbjogZXhjZXB0aW9uLCBjYXVzZTogY2F1c2UgfTtcbiAgICAgIGV4Y2VwdGlvbi5tZXNzYWdlID0gYXBwRXJyb3JQcmVmaXggKyBleGNlcHRpb24ubWVzc2FnZTtcbiAgICAgICRkZWxlZ2F0ZShleGNlcHRpb24sIGNhdXNlKTtcbiAgICAgIC8qKlxuICAgICAgICogQ291bGQgYWRkIHRoZSBlcnJvciB0byBhIHNlcnZpY2UncyBjb2xsZWN0aW9uLFxuICAgICAgICogYWRkIGVycm9ycyB0byAkcm9vdFNjb3BlLCBsb2cgZXJyb3JzIHRvIHJlbW90ZSB3ZWIgc2VydmVyLFxuICAgICAgICogb3IgbG9nIGxvY2FsbHkuIE9yIHRocm93IGhhcmQuIEl0IGlzIGVudGlyZWx5IHVwIHRvIHlvdS5cbiAgICAgICAqIHRocm93IGV4Y2VwdGlvbjtcbiAgICAgICAqXG4gICAgICAgKiBAZXhhbXBsZVxuICAgICAgICogICAgIHRocm93IHsgbWVzc2FnZTogJ2Vycm9yIG1lc3NhZ2Ugd2UgYWRkZWQnIH07XG4gICAgICAgKi9cbiAgICAgIGxvZ2dlci5lcnJvcihleGNlcHRpb24ubWVzc2FnZSwgZXJyb3JEYXRhKTtcbiAgICB9O1xuICB9XG59KSgpO1xuIiwiLyoganNoaW50IC1XMTE3LCAtVzAzMCAqL1xuZGVzY3JpYmUoJ2Jsb2Nrcy5leGNlcHRpb24nLCBmdW5jdGlvbigpIHtcbiAgdmFyIGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcjtcbiAgdmFyIG1vY2tzID0ge1xuICAgIGVycm9yTWVzc2FnZTogJ2Zha2UgZXJyb3InLFxuICAgIHByZWZpeDogJ1tURVNUXTogJ1xuICB9O1xuXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oKSB7XG4gICAgYmFyZC5hcHBNb2R1bGUoJ2Jsb2Nrcy5leGNlcHRpb24nLCBmdW5jdGlvbihfZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyXykge1xuICAgICAgZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyID0gX2V4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcl87XG4gICAgfSk7XG4gICAgYmFyZC5pbmplY3QoJyRyb290U2NvcGUnKTtcbiAgfSk7XG5cbiAgYmFyZC52ZXJpZnlOb091dHN0YW5kaW5nSHR0cFJlcXVlc3RzKCk7XG5cbiAgZGVzY3JpYmUoJ2V4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcicsIGZ1bmN0aW9uKCkge1xuICAgIGl0KCdzaG91bGQgaGF2ZSBhIGR1bW15IHRlc3QnLCBpbmplY3QoZnVuY3Rpb24oKSB7XG4gICAgICBleHBlY3QodHJ1ZSkudG8uZXF1YWwodHJ1ZSk7XG4gICAgfSkpO1xuXG4gICAgaXQoJ3Nob3VsZCBoYXZlIGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlciBkZWZpbmVkJywgaW5qZWN0KGZ1bmN0aW9uKCkge1xuICAgICAgZXhwZWN0KGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcikudG8uYmUuZGVmaW5lZDtcbiAgICB9KSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhdmUgY29uZmlndXJhdGlvbicsIGluamVjdChmdW5jdGlvbigpIHtcbiAgICAgIGV4cGVjdChleGNlcHRpb25IYW5kbGVyUHJvdmlkZXIuY29uZmlnKS50by5iZS5kZWZpbmVkO1xuICAgIH0pKTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBjb25maWd1cmF0aW9uJywgaW5qZWN0KGZ1bmN0aW9uKCkge1xuICAgICAgZXhwZWN0KGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlci5jb25maWd1cmUpLnRvLmJlLmRlZmluZWQ7XG4gICAgfSkpO1xuXG4gICAgZGVzY3JpYmUoJ3dpdGggYXBwRXJyb3JQcmVmaXgnLCBmdW5jdGlvbigpIHtcbiAgICAgIGJlZm9yZUVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlci5jb25maWd1cmUobW9ja3MucHJlZml4KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhdmUgYXBwRXJyb3JQcmVmaXggZGVmaW5lZCcsIGluamVjdChmdW5jdGlvbigpIHtcbiAgICAgICAgZXhwZWN0KGV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlci4kZ2V0KCkuY29uZmlnLmFwcEVycm9yUHJlZml4KS50by5iZS5kZWZpbmVkO1xuICAgICAgfSkpO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhdmUgYXBwRXJyb3JQcmVmaXggc2V0IHByb3Blcmx5JywgaW5qZWN0KGZ1bmN0aW9uKCkge1xuICAgICAgICBleHBlY3QoZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLiRnZXQoKS5jb25maWcuYXBwRXJyb3JQcmVmaXgpXG4gICAgICAgICAgLnRvLmVxdWFsKG1vY2tzLnByZWZpeCk7XG4gICAgICB9KSk7XG5cbiAgICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3Igd2hlbiBmb3JjZWQnLCBpbmplY3QoZnVuY3Rpb24oKSB7XG4gICAgICAgIGV4cGVjdChmdW5jdGlvblRoYXRXaWxsVGhyb3cpLnRvLnRocm93KCk7XG4gICAgICB9KSk7XG5cbiAgICAgIGl0KCdtYW51YWwgZXJyb3IgaXMgaGFuZGxlZCBieSBkZWNvcmF0b3InLCBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIGV4Y2VwdGlvbjtcbiAgICAgICAgZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLmNvbmZpZ3VyZShtb2Nrcy5wcmVmaXgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uVGhhdFdpbGxUaHJvdyk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgZXhjZXB0aW9uID0gZXg7XG4gICAgICAgICAgZXhwZWN0KGV4Lm1lc3NhZ2UpLnRvLmVxdWFsKG1vY2tzLnByZWZpeCArIG1vY2tzLmVycm9yTWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBmdW5jdGlvbiBmdW5jdGlvblRoYXRXaWxsVGhyb3coKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKG1vY2tzLmVycm9yTWVzc2FnZSk7XG4gIH1cbn0pO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2Jsb2Nrcy5leGNlcHRpb24nKVxuICAgIC5mYWN0b3J5KCdleGNlcHRpb24nLCBleGNlcHRpb24pO1xuXG4gIC8qIEBuZ0luamVjdCAqL1xuICBmdW5jdGlvbiBleGNlcHRpb24oJHEsIGxvZ2dlcikge1xuICAgIHZhciBzZXJ2aWNlID0ge1xuICAgICAgY2F0Y2hlcjogY2F0Y2hlclxuICAgIH07XG4gICAgcmV0dXJuIHNlcnZpY2U7XG5cbiAgICBmdW5jdGlvbiBjYXRjaGVyKG1lc3NhZ2UpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgIHZhciB0aHJvd25EZXNjcmlwdGlvbjtcbiAgICAgICAgdmFyIG5ld01lc3NhZ2U7XG4gICAgICAgIGlmIChlLmRhdGEgJiYgZS5kYXRhLmRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgdGhyb3duRGVzY3JpcHRpb24gPSAnXFxuJyArIGUuZGF0YS5kZXNjcmlwdGlvbjtcbiAgICAgICAgICBuZXdNZXNzYWdlID0gbWVzc2FnZSArIHRocm93bkRlc2NyaXB0aW9uO1xuICAgICAgICB9XG4gICAgICAgIGUuZGF0YS5kZXNjcmlwdGlvbiA9IG5ld01lc3NhZ2U7XG4gICAgICAgIGxvZ2dlci5lcnJvcihuZXdNZXNzYWdlKTtcbiAgICAgICAgcmV0dXJuICRxLnJlamVjdChlKTtcbiAgICAgIH07XG4gICAgfVxuICB9XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2Jsb2Nrcy5sb2dnZXInKVxuICAgIC5mYWN0b3J5KCdsb2dnZXInLCBsb2dnZXIpO1xuXG4gIGxvZ2dlci4kaW5qZWN0ID0gWyckbG9nJywgJ3RvYXN0ciddO1xuXG4gIC8qIEBuZ0luamVjdCAqL1xuICBmdW5jdGlvbiBsb2dnZXIoJGxvZywgdG9hc3RyKSB7XG4gICAgdmFyIHNlcnZpY2UgPSB7XG4gICAgICBzaG93VG9hc3RzOiB0cnVlLFxuXG4gICAgICBlcnJvcjogZXJyb3IsXG4gICAgICBpbmZvOiBpbmZvLFxuICAgICAgc3VjY2Vzczogc3VjY2VzcyxcbiAgICAgIHdhcm5pbmc6IHdhcm5pbmcsXG5cbiAgICAgIC8vIHN0cmFpZ2h0IHRvIGNvbnNvbGU7IGJ5cGFzcyB0b2FzdHJcbiAgICAgIGxvZzogJGxvZy5sb2dcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZpY2U7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBmdW5jdGlvbiBlcnJvcihtZXNzYWdlLCBkYXRhLCB0aXRsZSkge1xuICAgICAgdG9hc3RyLmVycm9yKG1lc3NhZ2UsIHRpdGxlKTtcbiAgICAgICRsb2cuZXJyb3IoJ0Vycm9yOiAnICsgbWVzc2FnZSwgZGF0YSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaW5mbyhtZXNzYWdlLCBkYXRhLCB0aXRsZSkge1xuICAgICAgdG9hc3RyLmluZm8obWVzc2FnZSwgdGl0bGUpO1xuICAgICAgJGxvZy5pbmZvKCdJbmZvOiAnICsgbWVzc2FnZSwgZGF0YSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc3VjY2VzcyhtZXNzYWdlLCBkYXRhLCB0aXRsZSkge1xuICAgICAgdG9hc3RyLnN1Y2Nlc3MobWVzc2FnZSwgdGl0bGUpO1xuICAgICAgJGxvZy5pbmZvKCdTdWNjZXNzOiAnICsgbWVzc2FnZSwgZGF0YSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlLCBkYXRhLCB0aXRsZSkge1xuICAgICAgdG9hc3RyLndhcm5pbmcobWVzc2FnZSwgdGl0bGUpO1xuICAgICAgJGxvZy53YXJuKCdXYXJuaW5nOiAnICsgbWVzc2FnZSwgZGF0YSk7XG4gICAgfVxuICB9XG59ICgpKTtcbiIsIi8qIEhlbHAgY29uZmlndXJlIHRoZSBzdGF0ZS1iYXNlIHVpLnJvdXRlciAqL1xuKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2Jsb2Nrcy5yb3V0ZXInKVxuICAgIC5wcm92aWRlcigncm91dGVySGVscGVyJywgcm91dGVySGVscGVyUHJvdmlkZXIpO1xuXG4gIHJvdXRlckhlbHBlclByb3ZpZGVyLiRpbmplY3QgPSBbJyRsb2NhdGlvblByb3ZpZGVyJywgJyRzdGF0ZVByb3ZpZGVyJywgJyR1cmxSb3V0ZXJQcm92aWRlciddO1xuICAvKiBAbmdJbmplY3QgKi9cbiAgZnVuY3Rpb24gcm91dGVySGVscGVyUHJvdmlkZXIoJGxvY2F0aW9uUHJvdmlkZXIsICRzdGF0ZVByb3ZpZGVyLCAkdXJsUm91dGVyUHJvdmlkZXIpIHtcbiAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgZG9jVGl0bGU6IHVuZGVmaW5lZCxcbiAgICAgIHJlc29sdmVBbHdheXM6IHt9XG4gICAgfTtcblxuICAgIGlmICghKHdpbmRvdy5oaXN0b3J5ICYmIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSkpIHtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gJy8nO1xuICAgIH1cblxuICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTtcblxuICAgIHRoaXMuY29uZmlndXJlID0gZnVuY3Rpb24oY2ZnKSB7XG4gICAgICBhbmd1bGFyLmV4dGVuZChjb25maWcsIGNmZyk7XG4gICAgfTtcblxuICAgIHRoaXMuJGdldCA9IFJvdXRlckhlbHBlcjtcbiAgICBSb3V0ZXJIZWxwZXIuJGluamVjdCA9IFsnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCAnJHN0YXRlJywgJ2xvZ2dlciddO1xuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIFJvdXRlckhlbHBlcigkbG9jYXRpb24sICRyb290U2NvcGUsICRzdGF0ZSwgbG9nZ2VyKSB7XG4gICAgICB2YXIgaGFuZGxpbmdTdGF0ZUNoYW5nZUVycm9yID0gZmFsc2U7XG4gICAgICB2YXIgaGFzT3RoZXJ3aXNlID0gZmFsc2U7XG4gICAgICB2YXIgc3RhdGVDb3VudHMgPSB7XG4gICAgICAgIGVycm9yczogMCxcbiAgICAgICAgY2hhbmdlczogMFxuICAgICAgfTtcblxuICAgICAgdmFyIHNlcnZpY2UgPSB7XG4gICAgICAgIGNvbmZpZ3VyZVN0YXRlczogY29uZmlndXJlU3RhdGVzLFxuICAgICAgICBnZXRTdGF0ZXM6IGdldFN0YXRlcyxcbiAgICAgICAgc3RhdGVDb3VudHM6IHN0YXRlQ291bnRzXG4gICAgICB9O1xuXG4gICAgICBpbml0KCk7XG5cbiAgICAgIHJldHVybiBzZXJ2aWNlO1xuXG4gICAgICAvLy8vLy8vLy8vLy8vLy9cblxuICAgICAgZnVuY3Rpb24gY29uZmlndXJlU3RhdGVzKHN0YXRlcywgb3RoZXJ3aXNlUGF0aCkge1xuICAgICAgICBzdGF0ZXMuZm9yRWFjaChmdW5jdGlvbihzdGF0ZSkge1xuICAgICAgICAgIHN0YXRlLmNvbmZpZy5yZXNvbHZlID1cbiAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHN0YXRlLmNvbmZpZy5yZXNvbHZlIHx8IHt9LCBjb25maWcucmVzb2x2ZUFsd2F5cyk7XG4gICAgICAgICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoc3RhdGUuc3RhdGUsIHN0YXRlLmNvbmZpZyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAob3RoZXJ3aXNlUGF0aCAmJiAhaGFzT3RoZXJ3aXNlKSB7XG4gICAgICAgICAgaGFzT3RoZXJ3aXNlID0gdHJ1ZTtcbiAgICAgICAgICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKG90aGVyd2lzZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGhhbmRsZVJvdXRpbmdFcnJvcnMoKSB7XG4gICAgICAgIC8vIFJvdXRlIGNhbmNlbGxhdGlvbjpcbiAgICAgICAgLy8gT24gcm91dGluZyBlcnJvciwgZ28gdG8gdGhlIGRhc2hib2FyZC5cbiAgICAgICAgLy8gUHJvdmlkZSBhbiBleGl0IGNsYXVzZSBpZiBpdCB0cmllcyB0byBkbyBpdCB0d2ljZS5cbiAgICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZUVycm9yJyxcbiAgICAgICAgICBmdW5jdGlvbihldmVudCwgdG9TdGF0ZSwgdG9QYXJhbXMsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcywgZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChoYW5kbGluZ1N0YXRlQ2hhbmdlRXJyb3IpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGVDb3VudHMuZXJyb3JzKys7XG4gICAgICAgICAgICBoYW5kbGluZ1N0YXRlQ2hhbmdlRXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgdmFyIGRlc3RpbmF0aW9uID0gKHRvU3RhdGUgJiZcbiAgICAgICAgICAgICAgKHRvU3RhdGUudGl0bGUgfHwgdG9TdGF0ZS5uYW1lIHx8IHRvU3RhdGUubG9hZGVkVGVtcGxhdGVVcmwpKSB8fFxuICAgICAgICAgICAgICAndW5rbm93biB0YXJnZXQnO1xuICAgICAgICAgICAgdmFyIG1zZyA9ICdFcnJvciByb3V0aW5nIHRvICcgKyBkZXN0aW5hdGlvbiArICcuICcgK1xuICAgICAgICAgICAgICAoZXJyb3IuZGF0YSB8fCAnJykgKyAnLiA8YnIvPicgKyAoZXJyb3Iuc3RhdHVzVGV4dCB8fCAnJykgK1xuICAgICAgICAgICAgICAnOiAnICsgKGVycm9yLnN0YXR1cyB8fCAnJyk7XG4gICAgICAgICAgICBsb2dnZXIud2FybmluZyhtc2csIFt0b1N0YXRlXSk7XG4gICAgICAgICAgICAkbG9jYXRpb24ucGF0aCgnLycpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgZnVuY3Rpb24gaW5pdCgpIHtcbiAgICAgICAgaGFuZGxlUm91dGluZ0Vycm9ycygpO1xuICAgICAgICB1cGRhdGVEb2NUaXRsZSgpO1xuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBnZXRTdGF0ZXMoKSB7IHJldHVybiAkc3RhdGUuZ2V0KCk7IH1cblxuICAgICAgZnVuY3Rpb24gdXBkYXRlRG9jVGl0bGUoKSB7XG4gICAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJyxcbiAgICAgICAgICBmdW5jdGlvbihldmVudCwgdG9TdGF0ZSwgdG9QYXJhbXMsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcykge1xuICAgICAgICAgICAgc3RhdGVDb3VudHMuY2hhbmdlcysrO1xuICAgICAgICAgICAgaGFuZGxpbmdTdGF0ZUNoYW5nZUVycm9yID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgdGl0bGUgPSBjb25maWcuZG9jVGl0bGUgKyAnICcgKyAodG9TdGF0ZS50aXRsZSB8fCAnJyk7XG4gICAgICAgICAgICAkcm9vdFNjb3BlLnRpdGxlID0gdGl0bGU7IC8vIGRhdGEgYmluZCB0byA8dGl0bGU+XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufSkoKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
