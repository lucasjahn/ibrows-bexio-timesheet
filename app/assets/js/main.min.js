(function() {
  'use strict';

  angular.module('app', [
    'app.core',
    //'app.widgets',
    //'app.admin',
    'app.dashboard'
  ]);

})();

(function() {
  'use strict';

  angular
    .module('app.core', [
        'ngAnimate',
        'ngSanitize',
        'ngRoute',

        // 3rd paty
        'lumx',
        'angular-electron',
        'ngStorage',
        'timer'
    ]);
})();

(function() {
  'use strict';

  angular.module('app.dashboard', ['app.core']);
})();

(function() {
  'use strict';

  var config = {
    clientId: '6777100542.apps.bexio.com',
    clientSecret: 'FfdjCu3Q3Rp8Ujmcch2iFGHJC3o=',
    authorizationUrl: 'https://office.bexio.com/oauth/authorize',
    tokenUrl: 'https://office.bexio.com/oauth/access_token',
    useBasicAuthorizationHeader: false
  };

  var scopes = [
    'article_show',
    'calendar_show',
    'contact_show',
    'lead_show',
    'task_show',
    'monitoring_show',
    'monitoring_edit',
    'project_show'
  ];

  angular
    .module('app.core')
    .factory('authservice', ['electron-oauth2', '$localStorage', authservice ]);


  function authservice(electronOauth2, $localStorage) {
    var service = {
      getAccessToken: getAccessToken
    };

    return service;

    function getAccessToken() {
      var windowParams = {
        width: 800,
        height: 600,
        alwaysOnTop: true,
        autoHideMenuBar: true,
        webPreferences: {
          nodeIntegration: false
        },
        closable: false,
        frame: false,
        center: true
      };
      
      var options = {
        scope: scopes.join(' '),
        state: Math.random().toString(36).substring(7)
      };

      var myApiOauth = electronOauth2(config, windowParams);

      // Get access token promise (electron-oauth2)
      return myApiOauth.getAccessToken(options)
    }
  }
})();

(function() {
  'use strict';

  bexioservice.$inject = ['$http', '$q', '$localStorage'];
  angular
    .module('app.core')
    .factory('bexioservice', bexioservice);

  /* @ngInject */
  function bexioservice($http, $q, $localStorage) {
    var service = {
      getTimesByUser: getTimesByUser,
      getProjects: getProjects,
      getProjectById: getProjectById,
      getContacts: getContacts,
      getContactById: getContactById,
      getServices: getServices,
      getServiceById: getServiceById
    };

    return service;

    // Read user data
    function getTimesByUser(userId) {
      var userData = $localStorage.userData;

      var filter = [
        {
          'field': 'user_id',
          'value': userId
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/timesheet/search?&limit=20&order_by=id_desc`,
        data: filter
      };

      return $http(request);

    }

    function getProjects() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/pr_project?order_by=id`
      };

      return $http(request);
    }

    function getProjectById(id) {
      return  getObjById($localStorage.projects, 'id', id);
    }

    function getContacts() {
      var userData = $localStorage.userData;

      var filter = [
        {
          "field": "contact_type_id",
          "value": 1
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/contact/search`,
        data: filter
      };

      return $http(request);
    }

    function getContactById(id) {
      return  getObjById($localStorage.contacts, 'id', id);
    }

    function getObjById(obj, field, value) {
      var search = {};
      search[field] = value;

      return _.findWhere(obj, search);
    }

    function getServices() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/client_service`
      };

      return $http(request);
    }

    function getServiceById(id) {
      return  getObjById($localStorage.services, 'id', id);
    }
  }
})();

(function() {
  'use strict';

  var core = angular.module('app.core');

  core
      .config(['remoteProvider', function(remoteProvider) {
        remoteProvider.register('electron-oauth2');
      }])
      .run(['$http', '$localStorage', function($http, $localStorage) {
          if ($localStorage.userData) {
              $http.defaults.headers.common.Authorization = `Bearer ${$localStorage.userData.access_token}`;
              $http.defaults.headers.common.Accept = 'application/json';
          }
      }]);


})();

/* global toastr:false, moment:false */
(function() {
  'use strict';

  angular
    .module('app.core')
})();

(function () {
    'use strict';

    getRoutes.$inject = ['$routeProvider'];
    angular
        .module('app.dashboard')
        .config(getRoutes);

    /* @ngInject */
    function getRoutes($routeProvider) {
        $routeProvider
            .when('/', {
                templateUrl: 'dashboard/dashboard.html',
                controller: 'Dashboard',
                controllerAs: 'vm'
            })
            .otherwise({
                redirectTo: '/'
            });
    }

})();
(function() {
  'use strict';

  Dashboard.$inject = ['$q', 'authservice', '$localStorage', 'bexioservice'];
  angular
    .module('app.dashboard')
    .controller('Dashboard', Dashboard);

  /* @ngInject */
  function Dashboard($q, authservice, $localStorage, bexioservice) {
      var vm = this;
      vm.title = 'Track your Time!';
      vm.times = '';
      vm.projects = '';


      ///////////////////////

      var now = new Date();

      if(!$localStorage.userData) {
          authservice.getAccessToken()
              .then(function(data) {
                  // Save access data
                  var d = new Date();
                  d = new Date(d.getTime() + data.expires_in);
                  data.expires = d.toString();

                  $localStorage.userData = data;
                  return getTimes(data.user_id);
              })
              .then(function(result) {
                  vm.times = result.data;
                  
              });
      } else {
          getTimes($localStorage.userData.user_id)
              .then(function(result) {
                  vm.times = result.data;
              });
      }

      bexioservice.getProjects()
          .then(function(result) {
              $localStorage.projects = vm.projects = result.data;
          });
      
      bexioservice.getContacts()
          .then(function(result) {
              $localStorage.contacts = vm.contacts = result.data;
          });

      bexioservice.getServices()
          .then(function(result) {
              $localStorage.services = vm.services = result.data;
          });

      $q.all([bexioservice.getContacts(), bexioservice.getProjects(), bexioservice.getServices()]).then(function() {
          vm.times = $localStorage.times = _.map(vm.times, function(obj, key) {
              obj.contact = bexioservice.getContactById(obj.contact_id);
              obj.project = bexioservice.getProjectById(obj.pr_project_id);
              obj.client_service = bexioservice.getServiceById(obj.slient_service_id);

              return obj;
          });

          console.log()
      });

      function getTimes(userId) {
          return bexioservice.getTimesByUser(userId);
      }
  }
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5tb2R1bGUuanMiLCJjb3JlL2NvcmUubW9kdWxlLmpzIiwiZGFzaGJvYXJkL2Rhc2hib2FyZC5tb2R1bGUuanMiLCJjb3JlL2F1dGhzZXJ2aWNlLmpzIiwiY29yZS9iZXhpb3NlcnZpY2UuanMiLCJjb3JlL2NvbmZpZy5qcyIsImNvcmUvY29uc3RhbnRzLmpzIiwiZGFzaGJvYXJkL2NvbmZpZy5yb3V0ZS5qcyIsImRhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxDQUFBLFdBQUE7RUFDQTs7RUFFQSxRQUFBLE9BQUEsT0FBQTtJQUNBOzs7SUFHQTs7Ozs7QUNQQSxDQUFBLFdBQUE7RUFDQTs7RUFFQTtLQUNBLE9BQUEsWUFBQTtRQUNBO1FBQ0E7UUFDQTs7O1FBR0E7UUFDQTtRQUNBO1FBQ0E7Ozs7QUNiQSxDQUFBLFdBQUE7RUFDQTs7RUFFQSxRQUFBLE9BQUEsaUJBQUEsQ0FBQTs7O0FDSEEsQ0FBQSxXQUFBO0VBQ0E7O0VBRUEsSUFBQSxTQUFBO0lBQ0EsVUFBQTtJQUNBLGNBQUE7SUFDQSxrQkFBQTtJQUNBLFVBQUE7SUFDQSw2QkFBQTs7O0VBR0EsSUFBQSxTQUFBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTs7O0VBR0E7S0FDQSxPQUFBO0tBQ0EsUUFBQSxlQUFBLENBQUEsbUJBQUEsaUJBQUE7OztFQUdBLFNBQUEsWUFBQSxnQkFBQSxlQUFBO0lBQ0EsSUFBQSxVQUFBO01BQ0EsZ0JBQUE7OztJQUdBLE9BQUE7O0lBRUEsU0FBQSxpQkFBQTtNQUNBLElBQUEsZUFBQTtRQUNBLE9BQUE7UUFDQSxRQUFBO1FBQ0EsYUFBQTtRQUNBLGlCQUFBO1FBQ0EsZ0JBQUE7VUFDQSxpQkFBQTs7UUFFQSxVQUFBO1FBQ0EsT0FBQTtRQUNBLFFBQUE7OztNQUdBLElBQUEsVUFBQTtRQUNBLE9BQUEsT0FBQSxLQUFBO1FBQ0EsT0FBQSxLQUFBLFNBQUEsU0FBQSxJQUFBLFVBQUE7OztNQUdBLElBQUEsYUFBQSxlQUFBLFFBQUE7OztNQUdBLE9BQUEsV0FBQSxlQUFBOzs7OztBQ3hEQSxDQUFBLFdBQUE7RUFDQTs7O0VBRUE7S0FDQSxPQUFBO0tBQ0EsUUFBQSxnQkFBQTs7O0VBR0EsU0FBQSxhQUFBLE9BQUEsSUFBQSxlQUFBO0lBQ0EsSUFBQSxVQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7TUFDQSxhQUFBO01BQ0EsZ0JBQUE7OztJQUdBLE9BQUE7OztJQUdBLFNBQUEsZUFBQSxRQUFBO01BQ0EsSUFBQSxXQUFBLGNBQUE7O01BRUEsSUFBQSxTQUFBO1FBQ0E7VUFDQSxTQUFBO1VBQ0EsU0FBQTs7OztNQUlBLElBQUEsVUFBQTtRQUNBLFFBQUE7UUFDQSxLQUFBO1FBQ0EsTUFBQTs7O01BR0EsT0FBQSxNQUFBOzs7O0lBSUEsU0FBQSxjQUFBO01BQ0EsSUFBQSxXQUFBLGNBQUE7O01BRUEsSUFBQSxVQUFBO1FBQ0EsUUFBQTtRQUNBLEtBQUE7OztNQUdBLE9BQUEsTUFBQTs7O0lBR0EsU0FBQSxlQUFBLElBQUE7TUFDQSxRQUFBLFdBQUEsY0FBQSxVQUFBLE1BQUE7OztJQUdBLFNBQUEsY0FBQTtNQUNBLElBQUEsV0FBQSxjQUFBOztNQUVBLElBQUEsU0FBQTtRQUNBO1VBQ0EsU0FBQTtVQUNBLFNBQUE7Ozs7TUFJQSxJQUFBLFVBQUE7UUFDQSxRQUFBO1FBQ0EsS0FBQTtRQUNBLE1BQUE7OztNQUdBLE9BQUEsTUFBQTs7O0lBR0EsU0FBQSxlQUFBLElBQUE7TUFDQSxRQUFBLFdBQUEsY0FBQSxVQUFBLE1BQUE7OztJQUdBLFNBQUEsV0FBQSxLQUFBLE9BQUEsT0FBQTtNQUNBLElBQUEsU0FBQTtNQUNBLE9BQUEsU0FBQTs7TUFFQSxPQUFBLEVBQUEsVUFBQSxLQUFBOzs7SUFHQSxTQUFBLGNBQUE7TUFDQSxJQUFBLFdBQUEsY0FBQTs7TUFFQSxJQUFBLFVBQUE7UUFDQSxRQUFBO1FBQ0EsS0FBQTs7O01BR0EsT0FBQSxNQUFBOzs7SUFHQSxTQUFBLGVBQUEsSUFBQTtNQUNBLFFBQUEsV0FBQSxjQUFBLFVBQUEsTUFBQTs7Ozs7QUNuR0EsQ0FBQSxXQUFBO0VBQ0E7O0VBRUEsSUFBQSxPQUFBLFFBQUEsT0FBQTs7RUFFQTtPQUNBLE9BQUEsQ0FBQSxrQkFBQSxTQUFBLGdCQUFBO1FBQ0EsZUFBQSxTQUFBOztPQUVBLElBQUEsQ0FBQSxTQUFBLGlCQUFBLFNBQUEsT0FBQSxlQUFBO1VBQ0EsSUFBQSxjQUFBLFVBQUE7Y0FDQSxNQUFBLFNBQUEsUUFBQSxPQUFBLGdCQUFBO2NBQ0EsTUFBQSxTQUFBLFFBQUEsT0FBQSxTQUFBOzs7Ozs7OztBQ1hBLENBQUEsV0FBQTtFQUNBOztFQUVBO0tBQ0EsT0FBQTs7O0FDTEEsQ0FBQSxZQUFBO0lBQ0E7OztJQUVBO1NBQ0EsT0FBQTtTQUNBLE9BQUE7OztJQUdBLFNBQUEsVUFBQSxnQkFBQTtRQUNBO2FBQ0EsS0FBQSxLQUFBO2dCQUNBLGFBQUE7Z0JBQ0EsWUFBQTtnQkFDQSxjQUFBOzthQUVBLFVBQUE7Z0JBQ0EsWUFBQTs7Ozs7QUNoQkEsQ0FBQSxXQUFBO0VBQ0E7OztFQUVBO0tBQ0EsT0FBQTtLQUNBLFdBQUEsYUFBQTs7O0VBR0EsU0FBQSxVQUFBLElBQUEsYUFBQSxlQUFBLGNBQUE7TUFDQSxJQUFBLEtBQUE7TUFDQSxHQUFBLFFBQUE7TUFDQSxHQUFBLFFBQUE7TUFDQSxHQUFBLFdBQUE7Ozs7O01BS0EsSUFBQSxNQUFBLElBQUE7O01BRUEsR0FBQSxDQUFBLGNBQUEsVUFBQTtVQUNBLFlBQUE7ZUFDQSxLQUFBLFNBQUEsTUFBQTs7a0JBRUEsSUFBQSxJQUFBLElBQUE7a0JBQ0EsSUFBQSxJQUFBLEtBQUEsRUFBQSxZQUFBLEtBQUE7a0JBQ0EsS0FBQSxVQUFBLEVBQUE7O2tCQUVBLGNBQUEsV0FBQTtrQkFDQSxPQUFBLFNBQUEsS0FBQTs7ZUFFQSxLQUFBLFNBQUEsUUFBQTtrQkFDQSxHQUFBLFFBQUEsT0FBQTs7O2FBR0E7VUFDQSxTQUFBLGNBQUEsU0FBQTtlQUNBLEtBQUEsU0FBQSxRQUFBO2tCQUNBLEdBQUEsUUFBQSxPQUFBOzs7O01BSUEsYUFBQTtXQUNBLEtBQUEsU0FBQSxRQUFBO2NBQ0EsY0FBQSxXQUFBLEdBQUEsV0FBQSxPQUFBOzs7TUFHQSxhQUFBO1dBQ0EsS0FBQSxTQUFBLFFBQUE7Y0FDQSxjQUFBLFdBQUEsR0FBQSxXQUFBLE9BQUE7OztNQUdBLGFBQUE7V0FDQSxLQUFBLFNBQUEsUUFBQTtjQUNBLGNBQUEsV0FBQSxHQUFBLFdBQUEsT0FBQTs7O01BR0EsR0FBQSxJQUFBLENBQUEsYUFBQSxlQUFBLGFBQUEsZUFBQSxhQUFBLGdCQUFBLEtBQUEsV0FBQTtVQUNBLEdBQUEsUUFBQSxjQUFBLFFBQUEsRUFBQSxJQUFBLEdBQUEsT0FBQSxTQUFBLEtBQUEsS0FBQTtjQUNBLElBQUEsVUFBQSxhQUFBLGVBQUEsSUFBQTtjQUNBLElBQUEsVUFBQSxhQUFBLGVBQUEsSUFBQTtjQUNBLElBQUEsaUJBQUEsYUFBQSxlQUFBLElBQUE7O2NBRUEsT0FBQTs7O1VBR0EsUUFBQTs7O01BR0EsU0FBQSxTQUFBLFFBQUE7VUFDQSxPQUFBLGFBQUEsZUFBQTs7OztBQUlBIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFtcbiAgICAnYXBwLmNvcmUnLFxuICAgIC8vJ2FwcC53aWRnZXRzJyxcbiAgICAvLydhcHAuYWRtaW4nLFxuICAgICdhcHAuZGFzaGJvYXJkJ1xuICBdKTtcblxufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdhcHAuY29yZScsIFtcbiAgICAgICAgJ25nQW5pbWF0ZScsXG4gICAgICAgICduZ1Nhbml0aXplJyxcbiAgICAgICAgJ25nUm91dGUnLFxuXG4gICAgICAgIC8vIDNyZCBwYXR5XG4gICAgICAgICdsdW14JyxcbiAgICAgICAgJ2FuZ3VsYXItZWxlY3Ryb24nLFxuICAgICAgICAnbmdTdG9yYWdlJyxcbiAgICAgICAgJ3RpbWVyJ1xuICAgIF0pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXIubW9kdWxlKCdhcHAuZGFzaGJvYXJkJywgWydhcHAuY29yZSddKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICB2YXIgY29uZmlnID0ge1xuICAgIGNsaWVudElkOiAnNjc3NzEwMDU0Mi5hcHBzLmJleGlvLmNvbScsXG4gICAgY2xpZW50U2VjcmV0OiAnRmZkakN1M1EzUnA4VWptY2NoMmlGR0hKQzNvPScsXG4gICAgYXV0aG9yaXphdGlvblVybDogJ2h0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9vYXV0aC9hdXRob3JpemUnLFxuICAgIHRva2VuVXJsOiAnaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL29hdXRoL2FjY2Vzc190b2tlbicsXG4gICAgdXNlQmFzaWNBdXRob3JpemF0aW9uSGVhZGVyOiBmYWxzZVxuICB9O1xuXG4gIHZhciBzY29wZXMgPSBbXG4gICAgJ2FydGljbGVfc2hvdycsXG4gICAgJ2NhbGVuZGFyX3Nob3cnLFxuICAgICdjb250YWN0X3Nob3cnLFxuICAgICdsZWFkX3Nob3cnLFxuICAgICd0YXNrX3Nob3cnLFxuICAgICdtb25pdG9yaW5nX3Nob3cnLFxuICAgICdtb25pdG9yaW5nX2VkaXQnLFxuICAgICdwcm9qZWN0X3Nob3cnXG4gIF07XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2FwcC5jb3JlJylcbiAgICAuZmFjdG9yeSgnYXV0aHNlcnZpY2UnLCBbJ2VsZWN0cm9uLW9hdXRoMicsICckbG9jYWxTdG9yYWdlJywgYXV0aHNlcnZpY2UgXSk7XG5cblxuICBmdW5jdGlvbiBhdXRoc2VydmljZShlbGVjdHJvbk9hdXRoMiwgJGxvY2FsU3RvcmFnZSkge1xuICAgIHZhciBzZXJ2aWNlID0ge1xuICAgICAgZ2V0QWNjZXNzVG9rZW46IGdldEFjY2Vzc1Rva2VuXG4gICAgfTtcblxuICAgIHJldHVybiBzZXJ2aWNlO1xuXG4gICAgZnVuY3Rpb24gZ2V0QWNjZXNzVG9rZW4oKSB7XG4gICAgICB2YXIgd2luZG93UGFyYW1zID0ge1xuICAgICAgICB3aWR0aDogODAwLFxuICAgICAgICBoZWlnaHQ6IDYwMCxcbiAgICAgICAgYWx3YXlzT25Ub3A6IHRydWUsXG4gICAgICAgIGF1dG9IaWRlTWVudUJhcjogdHJ1ZSxcbiAgICAgICAgd2ViUHJlZmVyZW5jZXM6IHtcbiAgICAgICAgICBub2RlSW50ZWdyYXRpb246IGZhbHNlXG4gICAgICAgIH0sXG4gICAgICAgIGNsb3NhYmxlOiBmYWxzZSxcbiAgICAgICAgZnJhbWU6IGZhbHNlLFxuICAgICAgICBjZW50ZXI6IHRydWVcbiAgICAgIH07XG4gICAgICBcbiAgICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgICBzY29wZTogc2NvcGVzLmpvaW4oJyAnKSxcbiAgICAgICAgc3RhdGU6IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KVxuICAgICAgfTtcblxuICAgICAgdmFyIG15QXBpT2F1dGggPSBlbGVjdHJvbk9hdXRoMihjb25maWcsIHdpbmRvd1BhcmFtcyk7XG5cbiAgICAgIC8vIEdldCBhY2Nlc3MgdG9rZW4gcHJvbWlzZSAoZWxlY3Ryb24tb2F1dGgyKVxuICAgICAgcmV0dXJuIG15QXBpT2F1dGguZ2V0QWNjZXNzVG9rZW4ob3B0aW9ucylcbiAgICB9XG4gIH1cbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmNvcmUnKVxuICAgIC5mYWN0b3J5KCdiZXhpb3NlcnZpY2UnLCBiZXhpb3NlcnZpY2UpO1xuXG4gIC8qIEBuZ0luamVjdCAqL1xuICBmdW5jdGlvbiBiZXhpb3NlcnZpY2UoJGh0dHAsICRxLCAkbG9jYWxTdG9yYWdlKSB7XG4gICAgdmFyIHNlcnZpY2UgPSB7XG4gICAgICBnZXRUaW1lc0J5VXNlcjogZ2V0VGltZXNCeVVzZXIsXG4gICAgICBnZXRQcm9qZWN0czogZ2V0UHJvamVjdHMsXG4gICAgICBnZXRQcm9qZWN0QnlJZDogZ2V0UHJvamVjdEJ5SWQsXG4gICAgICBnZXRDb250YWN0czogZ2V0Q29udGFjdHMsXG4gICAgICBnZXRDb250YWN0QnlJZDogZ2V0Q29udGFjdEJ5SWQsXG4gICAgICBnZXRTZXJ2aWNlczogZ2V0U2VydmljZXMsXG4gICAgICBnZXRTZXJ2aWNlQnlJZDogZ2V0U2VydmljZUJ5SWRcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZpY2U7XG5cbiAgICAvLyBSZWFkIHVzZXIgZGF0YVxuICAgIGZ1bmN0aW9uIGdldFRpbWVzQnlVc2VyKHVzZXJJZCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIGZpbHRlciA9IFtcbiAgICAgICAge1xuICAgICAgICAgICdmaWVsZCc6ICd1c2VyX2lkJyxcbiAgICAgICAgICAndmFsdWUnOiB1c2VySWRcbiAgICAgICAgfVxuICAgICAgXTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICB1cmw6IGBodHRwczovL29mZmljZS5iZXhpby5jb20vYXBpMi5waHAvJHt1c2VyRGF0YS5vcmd9L3RpbWVzaGVldC9zZWFyY2g/JmxpbWl0PTIwJm9yZGVyX2J5PWlkX2Rlc2NgLFxuICAgICAgICBkYXRhOiBmaWx0ZXJcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiAkaHR0cChyZXF1ZXN0KTtcblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFByb2plY3RzKCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHVybDogYGh0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9hcGkyLnBocC8ke3VzZXJEYXRhLm9yZ30vcHJfcHJvamVjdD9vcmRlcl9ieT1pZGBcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiAkaHR0cChyZXF1ZXN0KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRQcm9qZWN0QnlJZChpZCkge1xuICAgICAgcmV0dXJuICBnZXRPYmpCeUlkKCRsb2NhbFN0b3JhZ2UucHJvamVjdHMsICdpZCcsIGlkKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRDb250YWN0cygpIHtcbiAgICAgIHZhciB1c2VyRGF0YSA9ICRsb2NhbFN0b3JhZ2UudXNlckRhdGE7XG5cbiAgICAgIHZhciBmaWx0ZXIgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBcImZpZWxkXCI6IFwiY29udGFjdF90eXBlX2lkXCIsXG4gICAgICAgICAgXCJ2YWx1ZVwiOiAxXG4gICAgICAgIH1cbiAgICAgIF07XG5cbiAgICAgIHZhciByZXF1ZXN0ID0ge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL2FwaTIucGhwLyR7dXNlckRhdGEub3JnfS9jb250YWN0L3NlYXJjaGAsXG4gICAgICAgIGRhdGE6IGZpbHRlclxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldENvbnRhY3RCeUlkKGlkKSB7XG4gICAgICByZXR1cm4gIGdldE9iakJ5SWQoJGxvY2FsU3RvcmFnZS5jb250YWN0cywgJ2lkJywgaWQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldE9iakJ5SWQob2JqLCBmaWVsZCwgdmFsdWUpIHtcbiAgICAgIHZhciBzZWFyY2ggPSB7fTtcbiAgICAgIHNlYXJjaFtmaWVsZF0gPSB2YWx1ZTtcblxuICAgICAgcmV0dXJuIF8uZmluZFdoZXJlKG9iaiwgc2VhcmNoKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlcygpIHtcbiAgICAgIHZhciB1c2VyRGF0YSA9ICRsb2NhbFN0b3JhZ2UudXNlckRhdGE7XG5cbiAgICAgIHZhciByZXF1ZXN0ID0ge1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICB1cmw6IGBodHRwczovL29mZmljZS5iZXhpby5jb20vYXBpMi5waHAvJHt1c2VyRGF0YS5vcmd9L2NsaWVudF9zZXJ2aWNlYFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFNlcnZpY2VCeUlkKGlkKSB7XG4gICAgICByZXR1cm4gIGdldE9iakJ5SWQoJGxvY2FsU3RvcmFnZS5zZXJ2aWNlcywgJ2lkJywgaWQpO1xuICAgIH1cbiAgfVxufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciBjb3JlID0gYW5ndWxhci5tb2R1bGUoJ2FwcC5jb3JlJyk7XG5cbiAgY29yZVxuICAgICAgLmNvbmZpZyhbJ3JlbW90ZVByb3ZpZGVyJywgZnVuY3Rpb24ocmVtb3RlUHJvdmlkZXIpIHtcbiAgICAgICAgcmVtb3RlUHJvdmlkZXIucmVnaXN0ZXIoJ2VsZWN0cm9uLW9hdXRoMicpO1xuICAgICAgfV0pXG4gICAgICAucnVuKFsnJGh0dHAnLCAnJGxvY2FsU3RvcmFnZScsIGZ1bmN0aW9uKCRodHRwLCAkbG9jYWxTdG9yYWdlKSB7XG4gICAgICAgICAgaWYgKCRsb2NhbFN0b3JhZ2UudXNlckRhdGEpIHtcbiAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMuaGVhZGVycy5jb21tb24uQXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHskbG9jYWxTdG9yYWdlLnVzZXJEYXRhLmFjY2Vzc190b2tlbn1gO1xuICAgICAgICAgICAgICAkaHR0cC5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbi5BY2NlcHQgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgICAgICAgfVxuICAgICAgfV0pO1xuXG5cbn0pKCk7XG4iLCIvKiBnbG9iYWwgdG9hc3RyOmZhbHNlLCBtb21lbnQ6ZmFsc2UgKi9cbihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdhcHAuY29yZScpXG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ2FwcC5kYXNoYm9hcmQnKVxuICAgICAgICAuY29uZmlnKGdldFJvdXRlcyk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBnZXRSb3V0ZXMoJHJvdXRlUHJvdmlkZXIpIHtcbiAgICAgICAgJHJvdXRlUHJvdmlkZXJcbiAgICAgICAgICAgIC53aGVuKCcvJywge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnZGFzaGJvYXJkL2Rhc2hib2FyZC5odG1sJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnRGFzaGJvYXJkJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyQXM6ICd2bSdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub3RoZXJ3aXNlKHtcbiAgICAgICAgICAgICAgICByZWRpcmVjdFRvOiAnLydcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmRhc2hib2FyZCcpXG4gICAgLmNvbnRyb2xsZXIoJ0Rhc2hib2FyZCcsIERhc2hib2FyZCk7XG5cbiAgLyogQG5nSW5qZWN0ICovXG4gIGZ1bmN0aW9uIERhc2hib2FyZCgkcSwgYXV0aHNlcnZpY2UsICRsb2NhbFN0b3JhZ2UsIGJleGlvc2VydmljZSkge1xuICAgICAgdmFyIHZtID0gdGhpcztcbiAgICAgIHZtLnRpdGxlID0gJ1RyYWNrIHlvdXIgVGltZSEnO1xuICAgICAgdm0udGltZXMgPSAnJztcbiAgICAgIHZtLnByb2plY3RzID0gJyc7XG5cblxuICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGlmKCEkbG9jYWxTdG9yYWdlLnVzZXJEYXRhKSB7XG4gICAgICAgICAgYXV0aHNlcnZpY2UuZ2V0QWNjZXNzVG9rZW4oKVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAvLyBTYXZlIGFjY2VzcyBkYXRhXG4gICAgICAgICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICBkID0gbmV3IERhdGUoZC5nZXRUaW1lKCkgKyBkYXRhLmV4cGlyZXNfaW4pO1xuICAgICAgICAgICAgICAgICAgZGF0YS5leHBpcmVzID0gZC50b1N0cmluZygpO1xuXG4gICAgICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnVzZXJEYXRhID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRUaW1lcyhkYXRhLnVzZXJfaWQpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgIHZtLnRpbWVzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdldFRpbWVzKCRsb2NhbFN0b3JhZ2UudXNlckRhdGEudXNlcl9pZClcbiAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICB2bS50aW1lcyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKClcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgJGxvY2FsU3RvcmFnZS5wcm9qZWN0cyA9IHZtLnByb2plY3RzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgfSk7XG4gICAgICBcbiAgICAgIGJleGlvc2VydmljZS5nZXRDb250YWN0cygpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICRsb2NhbFN0b3JhZ2UuY29udGFjdHMgPSB2bS5jb250YWN0cyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgIH0pO1xuXG4gICAgICBiZXhpb3NlcnZpY2UuZ2V0U2VydmljZXMoKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnNlcnZpY2VzID0gdm0uc2VydmljZXMgPSByZXN1bHQuZGF0YTtcbiAgICAgICAgICB9KTtcblxuICAgICAgJHEuYWxsKFtiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdHMoKSwgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKCksIGJleGlvc2VydmljZS5nZXRTZXJ2aWNlcygpXSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICB2bS50aW1lcyA9ICRsb2NhbFN0b3JhZ2UudGltZXMgPSBfLm1hcCh2bS50aW1lcywgZnVuY3Rpb24ob2JqLCBrZXkpIHtcbiAgICAgICAgICAgICAgb2JqLmNvbnRhY3QgPSBiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdEJ5SWQob2JqLmNvbnRhY3RfaWQpO1xuICAgICAgICAgICAgICBvYmoucHJvamVjdCA9IGJleGlvc2VydmljZS5nZXRQcm9qZWN0QnlJZChvYmoucHJfcHJvamVjdF9pZCk7XG4gICAgICAgICAgICAgIG9iai5jbGllbnRfc2VydmljZSA9IGJleGlvc2VydmljZS5nZXRTZXJ2aWNlQnlJZChvYmouc2xpZW50X3NlcnZpY2VfaWQpO1xuXG4gICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZygpXG4gICAgICB9KTtcblxuICAgICAgZnVuY3Rpb24gZ2V0VGltZXModXNlcklkKSB7XG4gICAgICAgICAgcmV0dXJuIGJleGlvc2VydmljZS5nZXRUaW1lc0J5VXNlcih1c2VySWQpO1xuICAgICAgfVxuICB9XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
