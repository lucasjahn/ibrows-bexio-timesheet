(function() {
  'use strict';

  angular.module('app', [
    'app.core',
    //'app.widgets',
    //'app.admin',
    'app.dashboard'
  ]);

})();

(function() {
  'use strict';

  angular
    .module('app.core', [
        'ngAnimate',
        'ngSanitize',
        'ngRoute',

        // 3rd paty
        'lumx',
        'angular-electron',
        'ngStorage',
        'timer'
    ]);
})();

(function() {
  'use strict';

  angular.module('app.dashboard', ['app.core']);
})();

(function() {
  'use strict';

  var config = {
    clientId: '6777100542.apps.bexio.com',
    clientSecret: 'FfdjCu3Q3Rp8Ujmcch2iFGHJC3o=',
    authorizationUrl: 'https://office.bexio.com/oauth/authorize',
    tokenUrl: 'https://office.bexio.com/oauth/access_token',
    useBasicAuthorizationHeader: false
  };

  var scopes = [
    'article_show',
    'calendar_show',
    'contact_show',
    'lead_show',
    'task_show',
    'monitoring_show',
    'monitoring_edit',
    'project_show'
  ];

  angular
    .module('app.core')
    .factory('authservice', ['electron-oauth2', '$localStorage', authservice ]);


  function authservice(electronOauth2, $localStorage) {
    var service = {
      getAccessToken: getAccessToken
    };

    return service;

    function getAccessToken() {
      var windowParams = {
        width: 800,
        height: 600,
        alwaysOnTop: true,
        autoHideMenuBar: true,
        webPreferences: {
          nodeIntegration: false
        },
        closable: false,
        frame: false,
        center: true
      };
      
      var options = {
        scope: scopes.join(' '),
        state: Math.random().toString(36).substring(7)
      };

      var myApiOauth = electronOauth2(config, windowParams);

      // Get access token promise (electron-oauth2)
      return myApiOauth.getAccessToken(options)
    }
  }
})();

(function() {
  'use strict';

  bexioservice.$inject = ['$http', '$q', '$localStorage'];
  angular
    .module('app.core')
    .factory('bexioservice', bexioservice);

  /* @ngInject */
  function bexioservice($http, $q, $localStorage) {
    var service = {
      getTimesByUser: getTimesByUser,
      getProjects: getProjects,
      getProjectById: getProjectById,
      getContacts: getContacts,
      getContactById: getContactById,
      getServices: getServices,
      getServiceById: getServiceById
    };

    return service;

    // Read user data
    function getTimesByUser(userId) {
      var userData = $localStorage.userData;

      var filter = [
        {
          'field': 'user_id',
          'value': userId
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/timesheet/search?&limit=20&order_by=id_desc`,
        data: filter
      };

      return $http(request);

    }

    function getProjects() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/pr_project?order_by=id`
      };

      return $http(request);
    }

    function getProjectById(id) {
      return  getObjById($localStorage.projects, 'id', id);
    }

    function getContacts() {
      var userData = $localStorage.userData;

      var filter = [
        {
          "field": "contact_type_id",
          "value": 1
        }
      ];

      var request = {
        method: 'POST',
        url: `https://office.bexio.com/api2.php/${userData.org}/contact/search`,
        data: filter
      };

      return $http(request);
    }

    function getContactById(id) {
      return  getObjById($localStorage.contacts, 'id', id);
    }

    function getObjById(obj, field, value) {
      var search = {};
      search[field] = value;

      return _.findWhere(obj, search);
    }

    function getServices() {
      var userData = $localStorage.userData;

      var request = {
        method: 'GET',
        url: `https://office.bexio.com/api2.php/${userData.org}/client_service`
      };

      return $http(request);
    }

    function getServiceById(id) {
      return  getObjById($localStorage.services, 'id', id);
    }
  }
})();

(function() {
  'use strict';

  var core = angular.module('app.core');

  core
      .config(['remoteProvider', function(remoteProvider) {
        remoteProvider.register('electron-oauth2');
      }])
      .config(['$httpProvider', function ($httpProvider) {

          // Code for UI-Router have been removed for brevity

          // Inject APIInterceptor factory
          $httpProvider.interceptors.push('APIInterceptor');

      }])
      .run(['$http', '$localStorage', function($http, $localStorage) {
          if ($localStorage.userData) {
              $http.defaults.headers.common.Authorization = `Bearer ${$localStorage.userData.access_token}`;
              $http.defaults.headers.common.Accept = 'application/json';
          }
      }]);


})();

/* global toastr:false, moment:false */
(function() {
  'use strict';

  angular
    .module('app.core')
})();

(function() {
    'use strict';

    APIInterceptor.$inject = ['$q', '$injector'];
    angular
        .module('app.core')
        .factory('APIInterceptor', APIInterceptor);

    /* @ngInject */
    function APIInterceptor($q, $injector) {

        var APIInterceptor = {
            // On request success
            request: function(config) {
                console.log('REQUEST');
                console.log(config);
                //Return the config or wrap it in a promise if blank.
                return config || $q.when(config);
            },

            // On request failure
            requestError: function(rejection) {
                console.log('REJECTION');
                  console.log(rejection); // Contains the data about the error on the request.

                // Return the promise rejection.
                return $q.reject(rejection);
            },

            // On response success
            response: function(response) {
                console.log('RESPONSE');
                   console.log(response); // Contains the data from the response.

                // Return the response or promise.
                return response || $q.when(response);
            },

            // On response failture
            responseError: function(rejection) {

                // This will capture all HTTP errors such as 401 errors so be careful with your code. You can however
                // examine the "rejection" object so you can add more filtering
                var $localStorage = $injector.get('$localStorage');
                var $http = $injector.get('$http');
                var deferred = $q.defer();
                var authservice = $injector.get('authservice');

                // Session has expired
                if (rejection.status == 401) {

                    // Create a new session (recover the session)
                    // We use login method that logs the user in using the current credentials and
                    // returns a promise
                    var config = {
                        clientId: '6777100542.apps.bexio.com',
                        clientSecret: 'FfdjCu3Q3Rp8Ujmcch2iFGHJC3o=',
                        authorizationUrl: 'https://office.bexio.com/oauth/authorize',
                        tokenUrl: 'https://office.bexio.com/oauth/access_token',
                        useBasicAuthorizationHeader: false
                    };

                    var userData = $localStorage.userData;

                    var request = {
                        method: 'POST',
                        url: `https://office.bexio.com/oauth/refresh_token?client_id=${config.clientId}&client_secret=${config.clientSecret}&refresh_token=${userData.refresh_token}`
                    };

                    $http(request).then(deferred.resolve, deferred.reject);


                    // When the session recovered, make the same backend call again and chain the request
                    return deferred.promise.then(function (result) {
                        $localStorage.userData = result.data;
                        return $http(rejection.config);
                    });
                }

                else if (rejection.status == 404) {

                    authservice.getAccessToken().then(deferred.resolve, deferred.reject);

                    return deferred.promise.then(function (result) {
                        $localStorage.userData = result.data;
                        return $http(rejection.config);
                    });
                }

                return $q.reject(rejection);
            }
        };

        return APIInterceptor;
    }
})();

(function() {
    'use strict';

    SessionAPI.$inject = ['$rootScope', '$localStorage'];
    angular
        .module('app.core')
        .factory('SessionAPI', SessionAPI);

    /* @ngInject */
    function SessionAPI($rootScope, $localStorage) {

        var SessionAPI = {

            get: function (key) {
                return cookieStore.get(key);
            },
            remove: function(key) {
                cookieStore.remove(key, { path : '/', domain : COOKIE_DOMAINS });
            },

            // other methods have been removed for brevity

            destroy: function (message) {
                user = {};
                this.remove('id');
                this.remove('token');
                this.remove('expiresAt');
                this.remove('role');
                this.remove('authType');
                $rootScope.$emit('session:destroy', { message: message });
            }
        };
        return SessionAPI;
    }
})();

(function () {
    'use strict';

    getRoutes.$inject = ['$routeProvider'];
    angular
        .module('app.dashboard')
        .config(getRoutes);

    /* @ngInject */
    function getRoutes($routeProvider) {
        $routeProvider
            .when('/', {
                templateUrl: 'dashboard/dashboard.html',
                controller: 'Dashboard',
                controllerAs: 'vm'
            })
            .otherwise({
                redirectTo: '/'
            });
    }

})();
(function() {
  'use strict';

  Dashboard.$inject = ['$q', 'authservice', '$localStorage', 'bexioservice'];
  angular
    .module('app.dashboard')
    .controller('Dashboard', Dashboard);

  /* @ngInject */
  function Dashboard($q, authservice, $localStorage, bexioservice) {
      var vm = this;
      vm.title = 'Track your Time!';
      vm.times = '';
      vm.projects = '';


      ///////////////////////

      var now = new Date();

      if(!$localStorage.userData) {
          authservice.getAccessToken()
              .then(function(data) {
                  // Save access data
                  var d = new Date();
                  d = new Date(d.getTime() + data.expires_in);
                  data.expires = d.toString();

                  $localStorage.userData = data;
                  return getTimes(data.user_id);
              })
              .then(function(result) {
                  vm.times = result.data;
                  
              });
      } else {
          getTimes($localStorage.userData.user_id)
              .then(function(result) {
                  vm.times = result.data;
              });
      }

      bexioservice.getProjects()
          .then(function(result) {
              $localStorage.projects = vm.projects = result.data;
          });
      
      bexioservice.getContacts()
          .then(function(result) {
              $localStorage.contacts = vm.contacts = result.data;
          });

      bexioservice.getServices()
          .then(function(result) {
              $localStorage.services = vm.services = result.data;
          });

      $q.all([bexioservice.getContacts(), bexioservice.getProjects(), bexioservice.getServices()]).then(function() {
          vm.times = $localStorage.times = _.map(vm.times, function(obj, key) {
              obj.contact = bexioservice.getContactById(obj.contact_id);
              obj.project = bexioservice.getProjectById(obj.pr_project_id);
              obj.client_service = bexioservice.getServiceById(obj.slient_service_id);

              return obj;
          });

          console.log()
      });

      function getTimes(userId) {
          return bexioservice.getTimesByUser(userId);
      }
  }
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5tb2R1bGUuanMiLCJjb3JlL2NvcmUubW9kdWxlLmpzIiwiZGFzaGJvYXJkL2Rhc2hib2FyZC5tb2R1bGUuanMiLCJjb3JlL2F1dGhzZXJ2aWNlLmpzIiwiY29yZS9iZXhpb3NlcnZpY2UuanMiLCJjb3JlL2NvbmZpZy5qcyIsImNvcmUvY29uc3RhbnRzLmpzIiwiY29yZS9yZXN0aW50ZXJjZXB0b3IuanMiLCJjb3JlL3Nlc3Npb25hcGkuanMiLCJkYXNoYm9hcmQvY29uZmlnLnJvdXRlLmpzIiwiZGFzaGJvYXJkL2Rhc2hib2FyZC5jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLENBQUEsV0FBQTtFQUNBOztFQUVBLFFBQUEsT0FBQSxPQUFBO0lBQ0E7OztJQUdBOzs7OztBQ1BBLENBQUEsV0FBQTtFQUNBOztFQUVBO0tBQ0EsT0FBQSxZQUFBO1FBQ0E7UUFDQTtRQUNBOzs7UUFHQTtRQUNBO1FBQ0E7UUFDQTs7OztBQ2JBLENBQUEsV0FBQTtFQUNBOztFQUVBLFFBQUEsT0FBQSxpQkFBQSxDQUFBOzs7QUNIQSxDQUFBLFdBQUE7RUFDQTs7RUFFQSxJQUFBLFNBQUE7SUFDQSxVQUFBO0lBQ0EsY0FBQTtJQUNBLGtCQUFBO0lBQ0EsVUFBQTtJQUNBLDZCQUFBOzs7RUFHQSxJQUFBLFNBQUE7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBOzs7RUFHQTtLQUNBLE9BQUE7S0FDQSxRQUFBLGVBQUEsQ0FBQSxtQkFBQSxpQkFBQTs7O0VBR0EsU0FBQSxZQUFBLGdCQUFBLGVBQUE7SUFDQSxJQUFBLFVBQUE7TUFDQSxnQkFBQTs7O0lBR0EsT0FBQTs7SUFFQSxTQUFBLGlCQUFBO01BQ0EsSUFBQSxlQUFBO1FBQ0EsT0FBQTtRQUNBLFFBQUE7UUFDQSxhQUFBO1FBQ0EsaUJBQUE7UUFDQSxnQkFBQTtVQUNBLGlCQUFBOztRQUVBLFVBQUE7UUFDQSxPQUFBO1FBQ0EsUUFBQTs7O01BR0EsSUFBQSxVQUFBO1FBQ0EsT0FBQSxPQUFBLEtBQUE7UUFDQSxPQUFBLEtBQUEsU0FBQSxTQUFBLElBQUEsVUFBQTs7O01BR0EsSUFBQSxhQUFBLGVBQUEsUUFBQTs7O01BR0EsT0FBQSxXQUFBLGVBQUE7Ozs7O0FDeERBLENBQUEsV0FBQTtFQUNBOzs7RUFFQTtLQUNBLE9BQUE7S0FDQSxRQUFBLGdCQUFBOzs7RUFHQSxTQUFBLGFBQUEsT0FBQSxJQUFBLGVBQUE7SUFDQSxJQUFBLFVBQUE7TUFDQSxnQkFBQTtNQUNBLGFBQUE7TUFDQSxnQkFBQTtNQUNBLGFBQUE7TUFDQSxnQkFBQTtNQUNBLGFBQUE7TUFDQSxnQkFBQTs7O0lBR0EsT0FBQTs7O0lBR0EsU0FBQSxlQUFBLFFBQUE7TUFDQSxJQUFBLFdBQUEsY0FBQTs7TUFFQSxJQUFBLFNBQUE7UUFDQTtVQUNBLFNBQUE7VUFDQSxTQUFBOzs7O01BSUEsSUFBQSxVQUFBO1FBQ0EsUUFBQTtRQUNBLEtBQUE7UUFDQSxNQUFBOzs7TUFHQSxPQUFBLE1BQUE7Ozs7SUFJQSxTQUFBLGNBQUE7TUFDQSxJQUFBLFdBQUEsY0FBQTs7TUFFQSxJQUFBLFVBQUE7UUFDQSxRQUFBO1FBQ0EsS0FBQTs7O01BR0EsT0FBQSxNQUFBOzs7SUFHQSxTQUFBLGVBQUEsSUFBQTtNQUNBLFFBQUEsV0FBQSxjQUFBLFVBQUEsTUFBQTs7O0lBR0EsU0FBQSxjQUFBO01BQ0EsSUFBQSxXQUFBLGNBQUE7O01BRUEsSUFBQSxTQUFBO1FBQ0E7VUFDQSxTQUFBO1VBQ0EsU0FBQTs7OztNQUlBLElBQUEsVUFBQTtRQUNBLFFBQUE7UUFDQSxLQUFBO1FBQ0EsTUFBQTs7O01BR0EsT0FBQSxNQUFBOzs7SUFHQSxTQUFBLGVBQUEsSUFBQTtNQUNBLFFBQUEsV0FBQSxjQUFBLFVBQUEsTUFBQTs7O0lBR0EsU0FBQSxXQUFBLEtBQUEsT0FBQSxPQUFBO01BQ0EsSUFBQSxTQUFBO01BQ0EsT0FBQSxTQUFBOztNQUVBLE9BQUEsRUFBQSxVQUFBLEtBQUE7OztJQUdBLFNBQUEsY0FBQTtNQUNBLElBQUEsV0FB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O1FBQ0E7YUFDQSxLQUFBLEtBQUE7Z0JBQ0EsYUFBQTtnQkFDQSxZQUFBO2dCQUNBLGNBQUE7O2FBRUEsVUFBQTtnQkFDQSxZQUFBOzs7OztBQ2hCQSxDQUFBLFdBQUE7RUFDQTs7O0VBRUE7S0FDQSxPQUFBO0tBQ0EsV0FBQSxhQUFBOzs7RUFHQSxTQUFBLFVBQUEsSUFBQSxhQUFBLGVBQUEsY0FBQTtNQUNBLElBQUEsS0FBQTtNQUNBLEdBQUEsUUFBQTtNQUNBLEdBQUEsUUFBQTtNQUNBLEdBQUEsV0FBQTs7Ozs7TUFLQSxJQUFBLE1BQUEsSUFBQTs7TUFFQSxHQUFBLENBQUEsY0FBQSxVQUFBO1VBQ0EsWUFBQTtlQUNBLEtBQUEsU0FBQSxNQUFBOztrQkFFQSxJQUFBLElBQUEsSUFBQTtrQkFDQSxJQUFBLElBQUEsS0FBQSxFQUFBLFlBQUEsS0FBQTtrQkFDQSxLQUFBLFVBQUEsRUFBQTs7a0JBRUEsY0FBQSxXQUFBO2tCQUNBLE9BQUEsU0FBQSxLQUFBOztlQUVBLEtBQUEsU0FBQSxRQUFBO2tCQUNBLEdBQUEsUUFBQSxPQUFBOzs7YUFHQTtVQUNBLFNBQUEsY0FBQSxTQUFBO2VBQ0EsS0FBQSxTQUFBLFFBQUE7a0JBQ0EsR0FBQSxRQUFBLE9BQUE7Ozs7TUFJQSxhQUFBO1dBQ0EsS0FBQSxTQUFBLFFBQUE7Y0FDQSxjQUFBLFdBQUEsR0FBQSxXQUFBLE9BQUE7OztNQUdBLGFBQUE7V0FDQSxLQUFBLFNBQUEsUUFBQTtjQUNBLGNBQUEsV0FBQSxHQUFBLFdBQUEsT0FBQTs7O01BR0EsYUFBQTtXQUNBLEtBQUEsU0FBQSxRQUFBO2NBQ0EsY0FBQSxXQUFBLEdBQUEsV0FBQSxPQUFBOzs7TUFHQSxHQUFBLElBQUEsQ0FBQSxhQUFBLGVBQUEsYUFBQSxlQUFBLGFBQUEsZ0JBQUEsS0FBQSxXQUFBO1VBQ0EsR0FBQSxRQUFBLGNBQUEsUUFBQSxFQUFBLElBQUEsR0FBQSxPQUFBLFNBQUEsS0FBQSxLQUFBO2NBQ0EsSUFBQSxVQUFBLGFBQUEsZUFBQSxJQUFBO2NBQ0EsSUFBQSxVQUFBLGFBQUEsZUFBQSxJQUFBO2NBQ0EsSUFBQSxpQkFBQSxhQUFBLGVBQUEsSUFBQTs7Y0FFQSxPQUFBOzs7VUFHQSxRQUFBOzs7TUFHQSxTQUFBLFNBQUEsUUFBQTtVQUNBLE9BQUEsYUFBQSxlQUFBOzs7O0FBSUEiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyLm1vZHVsZSgnYXBwJywgW1xuICAgICdhcHAuY29yZScsXG4gICAgLy8nYXBwLndpZGdldHMnLFxuICAgIC8vJ2FwcC5hZG1pbicsXG4gICAgJ2FwcC5kYXNoYm9hcmQnXG4gIF0pO1xuXG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhclxuICAgIC5tb2R1bGUoJ2FwcC5jb3JlJywgW1xuICAgICAgICAnbmdBbmltYXRlJyxcbiAgICAgICAgJ25nU2FuaXRpemUnLFxuICAgICAgICAnbmdSb3V0ZScsXG5cbiAgICAgICAgLy8gM3JkIHBhdHlcbiAgICAgICAgJ2x1bXgnLFxuICAgICAgICAnYW5ndWxhci1lbGVjdHJvbicsXG4gICAgICAgICduZ1N0b3JhZ2UnLFxuICAgICAgICAndGltZXInXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgYW5ndWxhci5tb2R1bGUoJ2FwcC5kYXNoYm9hcmQnLCBbJ2FwcC5jb3JlJ10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciBjb25maWcgPSB7XG4gICAgY2xpZW50SWQ6ICc2Nzc3MTAwNTQyLmFwcHMuYmV4aW8uY29tJyxcbiAgICBjbGllbnRTZWNyZXQ6ICdGZmRqQ3UzUTNScDhVam1jY2gyaUZHSEpDM289JyxcbiAgICBhdXRob3JpemF0aW9uVXJsOiAnaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL29hdXRoL2F1dGhvcml6ZScsXG4gICAgdG9rZW5Vcmw6ICdodHRwczovL29mZmljZS5iZXhpby5jb20vb2F1dGgvYWNjZXNzX3Rva2VuJyxcbiAgICB1c2VCYXNpY0F1dGhvcml6YXRpb25IZWFkZXI6IGZhbHNlXG4gIH07XG5cbiAgdmFyIHNjb3BlcyA9IFtcbiAgICAnYXJ0aWNsZV9zaG93JyxcbiAgICAnY2FsZW5kYXJfc2hvdycsXG4gICAgJ2NvbnRhY3Rfc2hvdycsXG4gICAgJ2xlYWRfc2hvdycsXG4gICAgJ3Rhc2tfc2hvdycsXG4gICAgJ21vbml0b3Jpbmdfc2hvdycsXG4gICAgJ21vbml0b3JpbmdfZWRpdCcsXG4gICAgJ3Byb2plY3Rfc2hvdydcbiAgXTtcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmNvcmUnKVxuICAgIC5mYWN0b3J5KCdhdXRoc2VydmljZScsIFsnZWxlY3Ryb24tb2F1dGgyJywgJyRsb2NhbFN0b3JhZ2UnLCBhdXRoc2VydmljZSBdKTtcblxuXG4gIGZ1bmN0aW9uIGF1dGhzZXJ2aWNlKGVsZWN0cm9uT2F1dGgyLCAkbG9jYWxTdG9yYWdlKSB7XG4gICAgdmFyIHNlcnZpY2UgPSB7XG4gICAgICBnZXRBY2Nlc3NUb2tlbjogZ2V0QWNjZXNzVG9rZW5cbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZpY2U7XG5cbiAgICBmdW5jdGlvbiBnZXRBY2Nlc3NUb2tlbigpIHtcbiAgICAgIHZhciB3aW5kb3dQYXJhbXMgPSB7XG4gICAgICAgIHdpZHRoOiA4MDAsXG4gICAgICAgIGhlaWdodDogNjAwLFxuICAgICAgICBhbHdheXNPblRvcDogdHJ1ZSxcbiAgICAgICAgYXV0b0hpZGVNZW51QmFyOiB0cnVlLFxuICAgICAgICB3ZWJQcmVmZXJlbmNlczoge1xuICAgICAgICAgIG5vZGVJbnRlZ3JhdGlvbjogZmFsc2VcbiAgICAgICAgfSxcbiAgICAgICAgY2xvc2FibGU6IGZhbHNlLFxuICAgICAgICBmcmFtZTogZmFsc2UsXG4gICAgICAgIGNlbnRlcjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICAgIHNjb3BlOiBzY29wZXMuam9pbignICcpLFxuICAgICAgICBzdGF0ZTogTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDcpXG4gICAgICB9O1xuXG4gICAgICB2YXIgbXlBcGlPYXV0aCA9IGVsZWN0cm9uT2F1dGgyKGNvbmZpZywgd2luZG93UGFyYW1zKTtcblxuICAgICAgLy8gR2V0IGFjY2VzcyB0b2tlbiBwcm9taXNlIChlbGVjdHJvbi1vYXV0aDIpXG4gICAgICByZXR1cm4gbXlBcGlPYXV0aC5nZXRBY2Nlc3NUb2tlbihvcHRpb25zKVxuICAgIH1cbiAgfVxufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdhcHAuY29yZScpXG4gICAgLmZhY3RvcnkoJ2JleGlvc2VydmljZScsIGJleGlvc2VydmljZSk7XG5cbiAgLyogQG5nSW5qZWN0ICovXG4gIGZ1bmN0aW9uIGJleGlvc2VydmljZSgkaHR0cCwgJHEsICRsb2NhbFN0b3JhZ2UpIHtcbiAgICB2YXIgc2VydmljZSA9IHtcbiAgICAgIGdldFRpbWVzQnlVc2VyOiBnZXRUaW1lc0J5VXNlcixcbiAgICAgIGdldFByb2plY3RzOiBnZXRQcm9qZWN0cyxcbiAgICAgIGdldFByb2plY3RCeUlkOiBnZXRQcm9qZWN0QnlJZCxcbiAgICAgIGdldENvbnRhY3RzOiBnZXRDb250YWN0cyxcbiAgICAgIGdldENvbnRhY3RCeUlkOiBnZXRDb250YWN0QnlJZCxcbiAgICAgIGdldFNlcnZpY2VzOiBnZXRTZXJ2aWNlcyxcbiAgICAgIGdldFNlcnZpY2VCeUlkOiBnZXRTZXJ2aWNlQnlJZFxuICAgIH07XG5cbiAgICByZXR1cm4gc2VydmljZTtcblxuICAgIC8vIFJlYWQgdXNlciBkYXRhXG4gICAgZnVuY3Rpb24gZ2V0VGltZXNCeVVzZXIodXNlcklkKSB7XG4gICAgICB2YXIgdXNlckRhdGEgPSAkbG9jYWxTdG9yYWdlLnVzZXJEYXRhO1xuXG4gICAgICB2YXIgZmlsdGVyID0gW1xuICAgICAgICB7XG4gICAgICAgICAgJ2ZpZWxkJzogJ3VzZXJfaWQnLFxuICAgICAgICAgICd2YWx1ZSc6IHVzZXJJZFxuICAgICAgICB9XG4gICAgICBdO1xuXG4gICAgICB2YXIgcmVxdWVzdCA9IHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIHVybDogYGh0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9hcGkyLnBocC8ke3VzZXJEYXRhLm9yZ30vdGltZXNoZWV0L3NlYXJjaD8mbGltaXQ9MjAmb3JkZXJfYnk9aWRfZGVzY2AsXG4gICAgICAgIGRhdGE6IGZpbHRlclxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0UHJvamVjdHMoKSB7XG4gICAgICB2YXIgdXNlckRhdGEgPSAkbG9jYWxTdG9yYWdlLnVzZXJEYXRhO1xuXG4gICAgICB2YXIgcmVxdWVzdCA9IHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL2FwaTIucGhwLyR7dXNlckRhdGEub3JnfS9wcl9wcm9qZWN0P29yZGVyX2J5PWlkYFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuICRodHRwKHJlcXVlc3QpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFByb2plY3RCeUlkKGlkKSB7XG4gICAgICByZXR1cm4gIGdldE9iakJ5SWQoJGxvY2FsU3RvcmFnZS5wcm9qZWN0cywgJ2lkJywgaWQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldENvbnRhY3RzKCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIGZpbHRlciA9IFtcbiAgICAgICAge1xuICAgICAgICAgIFwiZmllbGRcIjogXCJjb250YWN0X3R5cGVfaWRcIixcbiAgICAgICAgICBcInZhbHVlXCI6IDFcbiAgICAgICAgfVxuICAgICAgXTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICB1cmw6IGBodHRwczovL29mZmljZS5iZXhpby5jb20vYXBpMi5waHAvJHt1c2VyRGF0YS5vcmd9L2NvbnRhY3Qvc2VhcmNoYCxcbiAgICAgICAgZGF0YTogZmlsdGVyXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gJGh0dHAocmVxdWVzdCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0Q29udGFjdEJ5SWQoaWQpIHtcbiAgICAgIHJldHVybiAgZ2V0T2JqQnlJZCgkbG9jYWxTdG9yYWdlLmNvbnRhY3RzLCAnaWQnLCBpZCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0T2JqQnlJZChvYmosIGZpZWxkLCB2YWx1ZSkge1xuICAgICAgdmFyIHNlYXJjaCA9IHt9O1xuICAgICAgc2VhcmNoW2ZpZWxkXSA9IHZhbHVlO1xuXG4gICAgICByZXR1cm4gXy5maW5kV2hlcmUob2JqLCBzZWFyY2gpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFNlcnZpY2VzKCkge1xuICAgICAgdmFyIHVzZXJEYXRhID0gJGxvY2FsU3RvcmFnZS51c2VyRGF0YTtcblxuICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHVybDogYGh0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9hcGkyLnBocC8ke3VzZXJEYXRhLm9yZ30vY2xpZW50X3NlcnZpY2VgXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gJGh0dHAocmVxdWVzdCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0U2VydmljZUJ5SWQoaWQpIHtcbiAgICAgIHJldHVybiAgZ2V0T2JqQnlJZCgkbG9jYWxTdG9yYWdlLnNlcnZpY2VzLCAnaWQnLCBpZCk7XG4gICAgfVxuICB9XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgdmFyIGNvcmUgPSBhbmd1bGFyLm1vZHVsZSgnYXBwLmNvcmUnKTtcblxuICBjb3JlXG4gICAgICAuY29uZmlnKFsncmVtb3RlUHJvdmlkZXInLCBmdW5jdGlvbihyZW1vdGVQcm92aWRlcikge1xuICAgICAgICByZW1vdGVQcm92aWRlci5yZWdpc3RlcignZWxlY3Ryb24tb2F1dGgyJyk7XG4gICAgICB9XSlcbiAgICAgIC5jb25maWcoZnVuY3Rpb24gKCRodHRwUHJvdmlkZXIpIHtcblxuICAgICAgICAgIC8vIENvZGUgZm9yIFVJLVJvdXRlciBoYXZlIGJlZW4gcmVtb3ZlZCBmb3IgYnJldml0eVxuXG4gICAgICAgICAgLy8gSW5qZWN0IEFQSUludGVyY2VwdG9yIGZhY3RvcnlcbiAgICAgICAgICAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9ycy5wdXNoKCdBUElJbnRlcmNlcHRvcicpO1xuXG4gICAgICB9KVxuICAgICAgLnJ1bihbJyRodHRwJywgJyRsb2NhbFN0b3JhZ2UnLCBmdW5jdGlvbigkaHR0cCwgJGxvY2FsU3RvcmFnZSkge1xuICAgICAgICAgIGlmICgkbG9jYWxTdG9yYWdlLnVzZXJEYXRhKSB7XG4gICAgICAgICAgICAgICRodHRwLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uLkF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7JGxvY2FsU3RvcmFnZS51c2VyRGF0YS5hY2Nlc3NfdG9rZW59YDtcbiAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMuaGVhZGVycy5jb21tb24uQWNjZXB0ID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICAgICAgICAgIH1cbiAgICAgIH1dKTtcblxuXG59KSgpO1xuIiwiLyogZ2xvYmFsIHRvYXN0cjpmYWxzZSwgbW9tZW50OmZhbHNlICovXG4oZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmNvcmUnKVxufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ2FwcC5jb3JlJylcbiAgICAgICAgLmZhY3RvcnkoJ0FQSUludGVyY2VwdG9yJywgQVBJSW50ZXJjZXB0b3IpO1xuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gQVBJSW50ZXJjZXB0b3IoJHEsICRpbmplY3Rvcikge1xuXG4gICAgICAgIHZhciBBUElJbnRlcmNlcHRvciA9IHtcbiAgICAgICAgICAgIC8vIE9uIHJlcXVlc3Qgc3VjY2Vzc1xuICAgICAgICAgICAgcmVxdWVzdDogZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1JFUVVFU1QnKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb25maWcpO1xuICAgICAgICAgICAgICAgIC8vUmV0dXJuIHRoZSBjb25maWcgb3Igd3JhcCBpdCBpbiBhIHByb21pc2UgaWYgYmxhbmsuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZyB8fCAkcS53aGVuKGNvbmZpZyk7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLyBPbiByZXF1ZXN0IGZhaWx1cmVcbiAgICAgICAgICAgIHJlcXVlc3RFcnJvcjogZnVuY3Rpb24ocmVqZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1JFSkVDVElPTicpO1xuICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVqZWN0aW9uKTsgLy8gQ29udGFpbnMgdGhlIGRhdGEgYWJvdXQgdGhlIGVycm9yIG9uIHRoZSByZXF1ZXN0LlxuXG4gICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBwcm9taXNlIHJlamVjdGlvbi5cbiAgICAgICAgICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLyBPbiByZXNwb25zZSBzdWNjZXNzXG4gICAgICAgICAgICByZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUkVTUE9OU0UnKTtcbiAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7IC8vIENvbnRhaW5zIHRoZSBkYXRhIGZyb20gdGhlIHJlc3BvbnNlLlxuXG4gICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSByZXNwb25zZSBvciBwcm9taXNlLlxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSB8fCAkcS53aGVuKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIC8vIE9uIHJlc3BvbnNlIGZhaWx0dXJlXG4gICAgICAgICAgICByZXNwb25zZUVycm9yOiBmdW5jdGlvbihyZWplY3Rpb24pIHtcblxuICAgICAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBjYXB0dXJlIGFsbCBIVFRQIGVycm9ycyBzdWNoIGFzIDQwMSBlcnJvcnMgc28gYmUgY2FyZWZ1bCB3aXRoIHlvdXIgY29kZS4gWW91IGNhbiBob3dldmVyXG4gICAgICAgICAgICAgICAgLy8gZXhhbWluZSB0aGUgXCJyZWplY3Rpb25cIiBvYmplY3Qgc28geW91IGNhbiBhZGQgbW9yZSBmaWx0ZXJpbmdcbiAgICAgICAgICAgICAgICB2YXIgJGxvY2FsU3RvcmFnZSA9ICRpbmplY3Rvci5nZXQoJyRsb2NhbFN0b3JhZ2UnKTtcbiAgICAgICAgICAgICAgICB2YXIgJGh0dHAgPSAkaW5qZWN0b3IuZ2V0KCckaHR0cCcpO1xuICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICAgICAgICAgICAgdmFyIGF1dGhzZXJ2aWNlID0gJGluamVjdG9yLmdldCgnYXV0aHNlcnZpY2UnKTtcblxuICAgICAgICAgICAgICAgIC8vIFNlc3Npb24gaGFzIGV4cGlyZWRcbiAgICAgICAgICAgICAgICBpZiAocmVqZWN0aW9uLnN0YXR1cyA9PSA0MDEpIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSBuZXcgc2Vzc2lvbiAocmVjb3ZlciB0aGUgc2Vzc2lvbilcbiAgICAgICAgICAgICAgICAgICAgLy8gV2UgdXNlIGxvZ2luIG1ldGhvZCB0aGF0IGxvZ3MgdGhlIHVzZXIgaW4gdXNpbmcgdGhlIGN1cnJlbnQgY3JlZGVudGlhbHMgYW5kXG4gICAgICAgICAgICAgICAgICAgIC8vIHJldHVybnMgYSBwcm9taXNlXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRJZDogJzY3NzcxMDA1NDIuYXBwcy5iZXhpby5jb20nLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50U2VjcmV0OiAnRmZkakN1M1EzUnA4VWptY2NoMmlGR0hKQzNvPScsXG4gICAgICAgICAgICAgICAgICAgICAgICBhdXRob3JpemF0aW9uVXJsOiAnaHR0cHM6Ly9vZmZpY2UuYmV4aW8uY29tL29hdXRoL2F1dGhvcml6ZScsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b2tlblVybDogJ2h0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9vYXV0aC9hY2Nlc3NfdG9rZW4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlQmFzaWNBdXRob3JpemF0aW9uSGVhZGVyOiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciB1c2VyRGF0YSA9ICRsb2NhbFN0b3JhZ2UudXNlckRhdGE7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYGh0dHBzOi8vb2ZmaWNlLmJleGlvLmNvbS9vYXV0aC9yZWZyZXNoX3Rva2VuP2NsaWVudF9pZD0ke2NvbmZpZy5jbGllbnRJZH0mY2xpZW50X3NlY3JldD0ke2NvbmZpZy5jbGllbnRTZWNyZXR9JnJlZnJlc2hfdG9rZW49JHt1c2VyRGF0YS5yZWZyZXNoX3Rva2VufWBcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAkaHR0cChyZXF1ZXN0KS50aGVuKGRlZmVycmVkLnJlc29sdmUsIGRlZmVycmVkLnJlamVjdCk7XG5cblxuICAgICAgICAgICAgICAgICAgICAvLyBXaGVuIHRoZSBzZXNzaW9uIHJlY292ZXJlZCwgbWFrZSB0aGUgc2FtZSBiYWNrZW5kIGNhbGwgYWdhaW4gYW5kIGNoYWluIHRoZSByZXF1ZXN0XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2FsU3RvcmFnZS51c2VyRGF0YSA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRodHRwKHJlamVjdGlvbi5jb25maWcpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChyZWplY3Rpb24uc3RhdHVzID09IDQwNCkge1xuXG4gICAgICAgICAgICAgICAgICAgIGF1dGhzZXJ2aWNlLmdldEFjY2Vzc1Rva2VuKCkudGhlbihkZWZlcnJlZC5yZXNvbHZlLCBkZWZlcnJlZC5yZWplY3QpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2FsU3RvcmFnZS51c2VyRGF0YSA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRodHRwKHJlamVjdGlvbi5jb25maWcpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIEFQSUludGVyY2VwdG9yO1xuICAgIH1cbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCdhcHAuY29yZScpXG4gICAgICAgIC5mYWN0b3J5KCdTZXNzaW9uQVBJJywgU2Vzc2lvbkFQSSk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBTZXNzaW9uQVBJKCRyb290U2NvcGUsICRsb2NhbFN0b3JhZ2UpIHtcblxuICAgICAgICB2YXIgU2Vzc2lvbkFQSSA9IHtcblxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvb2tpZVN0b3JlLmdldChrZXkpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgICAgICAgICAgY29va2llU3RvcmUucmVtb3ZlKGtleSwgeyBwYXRoIDogJy8nLCBkb21haW4gOiBDT09LSUVfRE9NQUlOUyB9KTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIC8vIG90aGVyIG1ldGhvZHMgaGF2ZSBiZWVuIHJlbW92ZWQgZm9yIGJyZXZpdHlcblxuICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICB1c2VyID0ge307XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoJ2lkJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoJ3Rva2VuJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoJ2V4cGlyZXNBdCcpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKCdyb2xlJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoJ2F1dGhUeXBlJyk7XG4gICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZW1pdCgnc2Vzc2lvbjpkZXN0cm95JywgeyBtZXNzYWdlOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gU2Vzc2lvbkFQSTtcbiAgICB9XG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ2FwcC5kYXNoYm9hcmQnKVxuICAgICAgICAuY29uZmlnKGdldFJvdXRlcyk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBnZXRSb3V0ZXMoJHJvdXRlUHJvdmlkZXIpIHtcbiAgICAgICAgJHJvdXRlUHJvdmlkZXJcbiAgICAgICAgICAgIC53aGVuKCcvJywge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnZGFzaGJvYXJkL2Rhc2hib2FyZC5odG1sJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnRGFzaGJvYXJkJyxcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyQXM6ICd2bSdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub3RoZXJ3aXNlKHtcbiAgICAgICAgICAgICAgICByZWRpcmVjdFRvOiAnLydcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXBwLmRhc2hib2FyZCcpXG4gICAgLmNvbnRyb2xsZXIoJ0Rhc2hib2FyZCcsIERhc2hib2FyZCk7XG5cbiAgLyogQG5nSW5qZWN0ICovXG4gIGZ1bmN0aW9uIERhc2hib2FyZCgkcSwgYXV0aHNlcnZpY2UsICRsb2NhbFN0b3JhZ2UsIGJleGlvc2VydmljZSkge1xuICAgICAgdmFyIHZtID0gdGhpcztcbiAgICAgIHZtLnRpdGxlID0gJ1RyYWNrIHlvdXIgVGltZSEnO1xuICAgICAgdm0udGltZXMgPSAnJztcbiAgICAgIHZtLnByb2plY3RzID0gJyc7XG5cblxuICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGlmKCEkbG9jYWxTdG9yYWdlLnVzZXJEYXRhKSB7XG4gICAgICAgICAgYXV0aHNlcnZpY2UuZ2V0QWNjZXNzVG9rZW4oKVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAvLyBTYXZlIGFjY2VzcyBkYXRhXG4gICAgICAgICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICBkID0gbmV3IERhdGUoZC5nZXRUaW1lKCkgKyBkYXRhLmV4cGlyZXNfaW4pO1xuICAgICAgICAgICAgICAgICAgZGF0YS5leHBpcmVzID0gZC50b1N0cmluZygpO1xuXG4gICAgICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnVzZXJEYXRhID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRUaW1lcyhkYXRhLnVzZXJfaWQpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgIHZtLnRpbWVzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdldFRpbWVzKCRsb2NhbFN0b3JhZ2UudXNlckRhdGEudXNlcl9pZClcbiAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICB2bS50aW1lcyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKClcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgJGxvY2FsU3RvcmFnZS5wcm9qZWN0cyA9IHZtLnByb2plY3RzID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgfSk7XG4gICAgICBcbiAgICAgIGJleGlvc2VydmljZS5nZXRDb250YWN0cygpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgICRsb2NhbFN0b3JhZ2UuY29udGFjdHMgPSB2bS5jb250YWN0cyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgIH0pO1xuXG4gICAgICBiZXhpb3NlcnZpY2UuZ2V0U2VydmljZXMoKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICAkbG9jYWxTdG9yYWdlLnNlcnZpY2VzID0gdm0uc2VydmljZXMgPSByZXN1bHQuZGF0YTtcbiAgICAgICAgICB9KTtcblxuICAgICAgJHEuYWxsKFtiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdHMoKSwgYmV4aW9zZXJ2aWNlLmdldFByb2plY3RzKCksIGJleGlvc2VydmljZS5nZXRTZXJ2aWNlcygpXSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICB2bS50aW1lcyA9ICRsb2NhbFN0b3JhZ2UudGltZXMgPSBfLm1hcCh2bS50aW1lcywgZnVuY3Rpb24ob2JqLCBrZXkpIHtcbiAgICAgICAgICAgICAgb2JqLmNvbnRhY3QgPSBiZXhpb3NlcnZpY2UuZ2V0Q29udGFjdEJ5SWQob2JqLmNvbnRhY3RfaWQpO1xuICAgICAgICAgICAgICBvYmoucHJvamVjdCA9IGJleGlvc2VydmljZS5nZXRQcm9qZWN0QnlJZChvYmoucHJfcHJvamVjdF9pZCk7XG4gICAgICAgICAgICAgIG9iai5jbGllbnRfc2VydmljZSA9IGJleGlvc2VydmljZS5nZXRTZXJ2aWNlQnlJZChvYmouc2xpZW50X3NlcnZpY2VfaWQpO1xuXG4gICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZygpXG4gICAgICB9KTtcblxuICAgICAgZnVuY3Rpb24gZ2V0VGltZXModXNlcklkKSB7XG4gICAgICAgICAgcmV0dXJuIGJleGlvc2VydmljZS5nZXRUaW1lc0J5VXNlcih1c2VySWQpO1xuICAgICAgfVxuICB9XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
